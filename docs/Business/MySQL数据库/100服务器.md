---
title: 100服务器数据库转移
date: 2023-5-23 10:42:12
---

---



## 转移方案



100服务器 主库和测试库转移到18服务器





## 18服务器MySQL安装方案

docker部署，做好数据映射和重启方案



docker 命令

```
docker run --restart=always  -d    --privileged=true   -v /dockerData/mysql/data:/var/lib/mysql   -p 3306:3306 --name mysql3306 -e MYSQL_ROOT_PASSWORD=Qianyan89892528  mysql:8.0.33 
```



docker-compose

安装







构建

```
docker-compose up

补充:
docker-compose up  #启动所有容器
docker-compose up -d  #后台启动并运行所有容器
docker-compose up --no-recreate -d  #不重新创建已经停止的容器
docker-compose up -d test2  #只启动test2这个容器
docker-compose stop  #停止容器
docker-compose start  #启动容器
docker-compose down #停止并销毁容器
```



配置

```
version: '3'
services:
  mysql:                                            #mysql服务节点
    image: mysql:8.0.33                                #mysql镜像，如果镜像容器没有会去自动拉取
    container_name: mysqlcompose3306                           #容器的名称
    command:                                        #构建容器后所执行的命令
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --lower-case-table-names=1    #忽略数据表明大小写 
    restart: always                                 #跟随docker的启动而启动
    environment:
      MYSQL_ROOT_PASSWORD: Qianyan89892528                     #设置root帐号密码
      SET_CONTAINER_TIMEZONE: true
      CONTAINER_TIMEZONE: Asia/Shanghai                       #time
    ports:
      - 3306:3306
    volumes:
      - /data/dockerData/mysql/data:/var/lib/mysql           #数据文件挂载
      - /data/dockerData/mysql/conf.d:/etc/mysql/conf.d      #配置文件挂载
      - /data/dockerData/mysql/log:/var/log/mysql            #日志文件挂载
      - /etc/localtime:/etc/localtime

```



my.cnf

```
[mysqld]

port=3306

# 数据存放的地方
datadir=/var/lib/mysql
# 连接的地方
#socket=/data/mysql/mysql.sock
# 错误日志输出地方
#log-error=/data/dockerData/mysql/errorlog
# 进程文件
#pid-file=/data/mysql/run/mysqld/mysqld.pid
# 缓存的地方
#tmpdir=/data/dockerData/mysql/tmp
# 分组权限
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
# 大小写敏感
lower_case_table_names=1

log-bin=mysql100-master
server-id=4
# 开启binlog
#log_bin= mysql-bin
#log_bin_basename=/opt/mysql/mysql-bin
#log_bin_index=/opt/mysql/mysql-bin.index
innodb_buffer_pool_size=4G
innodb_io_capacity= 20000
max_allowed_packet=256M
key_buffer_size= 2048M
character-set-server=utf8
default-storage-engine=InnoDB
max_connections = 5000
max_connect_errors = 6000
thread_cache_size = 64
innodb_open_files = 500
myisam_max_sort_file_size=100G
myisam_sort_buffer_size=35M
innodb_flush_log_at_trx_commit=1
innodb_thread_concurrency=18
binlog_cache_size = 32768
max_heap_table_size = 16M
tmp_table_size = 512M
join_buffer_size = 16M
sort_buffer_size = 16M
read_rnd_buffer_size = 8M 
read_buffer_size = 2M
interactive_timeout = 28800
wait_timeout = 28800
log_bin_trust_function_creators = ON
transaction_isolation = REPEATABLE-READ
binlog_format = ROW
expire_logs_days = 7
slow_query_log = 0
#慢日志目录
slow_query_log_file=/data/dockerData/mysql/lib/mysql/mysql100-slow.log
#等待时间超过5s算慢日志 
long_query_time = 20
log_slave_updates = true
back_log = 600
innodb_file_per_table = ON
open_files_limit = 65535
table_open_cache = 512
innodb_write_io_threads = 32
innodb_read_io_threads = 32
innodb_purge_threads = 1
innodb_log_buffer_size = 2M
innodb_log_file_size = 32M
innodb_max_dirty_pages_pct = 90
bulk_insert_buffer_size = 8M
group_concat_max_len=102400

[mysql] 

# 客户端配置 # 

port= 3306 

socket=/data/mysql/mysql.sock 

default-character-set= utf8

```







注:

 /etc/localtime:/etc/localtime 用于解决时区问题







查看docker容器内

```
docker exec -it 应用idorname bash
```





docker-compose 后台运行

```
docker compose up -d
```









---

参考文档

https://blog.csdn.net/cast_lzl/article/details/115833302



