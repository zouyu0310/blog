(window.webpackJsonp=window.webpackJsonp||[]).push([[526],{1200:function(t,s,e){"use strict";e.r(s);var a=e(14),n=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"redistemplate连接集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redistemplate连接集群"}},[t._v("#")]),t._v(" RedisTemplate连接集群")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("启动Redis集群6台实例")])]),t._v(" "),s("li",[s("p",[t._v("第一次改写YML")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ===========================redis集群===========================")]),t._v("\nspring.redis.password=123456\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取失败 最大重定向次数")]),t._v("\nspring.redis.cluster.max"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("redirects=3\nspring.redis.lettuce.pool.max"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("active=8\nspring.redis.1ettuce.pool.max"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("wait="),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1ms\nspring.redis.1ettuce.pool.max"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("idle=8\nspring.redis.lettuce.pool.min"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("idle=0\nspring.redis.cluster.nodes=192.168.111.175"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("192.168.111.175"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("192.168.111.176"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("192.168.111.176"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6384")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("直接通过微服务访问Redis集群")]),t._v(" "),s("p",[t._v("一切正常 （http://localhost:7777/swagger-ui.html）")])]),t._v(" "),s("li",[s("p",[t._v("$\\textcolor{red}{\\large 问题来了}$")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("人为模拟，master-6381机器意外宕机，手动shutdown")])]),t._v(" "),s("li",[s("p",[t._v("先对redis集群用命令的方式，手动验证各种读写命令，看看6384是否上位")])]),t._v(" "),s("li",[s("p",[t._v("Redis Cluster集群能自动感知并自动完成主备切换，对应的slave6384会被选举为新的master节点")])]),t._v(" "),s("li",[s("p",[t._v("通过redis客户端连接6384可以正常进行读写操作")])]),t._v(" "),s("li",[s("p",[t._v("$\\textcolor{green}{\\large 微服务客户端再次读写访问试试}$")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("故障现象")]),t._v(" "),s("p",[t._v("SpringBoot客户端没有动态感知RedisCluster的最新集群信息")]),t._v(" "),s("p",[t._v("金典故障")]),t._v(" "),s("p",[t._v("【故障演练】 Redis Cluster集群部署采用了3主3从拓扑结构，数据读写访问master节点，slave节点负责备份。$\\textcolor{red}{\\large 当master宕机主从切换成功，redis手动OK，but 2个经典故障}$")]),t._v(" "),s("p",[s("img",{attrs:{src:"images/6.png",alt:""}})])]),t._v(" "),s("li",[s("p",[t._v("导致原因\nSpringBoot 2.X版本，Redis默认的连接池采用Lettuce，当Redis集群节点发生变化后，Letture默认是不会刷新节点拓扑")])]),t._v(" "),s("li",[s("p",[t._v("解决方案")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("排除lettuce采用Jedis（不推荐）")]),t._v(" "),s("p",[s("img",{attrs:{src:"images/7.png",alt:""}})])]),t._v(" "),s("li",[s("p",[t._v("重写连接工厂实例（极度不推荐）")])]),t._v(" "),s("li",[s("p",[t._v("刷新节点集群拓扑动态感应")]),t._v(" "),s("p",[s("img",{attrs:{src:"images/8.png",alt:""}})]),t._v(" "),s("p",[t._v("解决方法：")]),t._v(" "),s("ul",[s("li",[t._v("调用 RedisClusterClient.reloadPartitions")]),t._v(" "),s("li",[t._v("后台基于时间间隔的周期刷新")]),t._v(" "),s("li",[t._v("后台基于持续的 "),s("strong",[t._v("断开")]),t._v(" 和 "),s("strong",[t._v("移动")]),t._v("、"),s("strong",[t._v("重定向")]),t._v(" 的自适应更新")])])])])]),t._v(" "),s("li")])])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);