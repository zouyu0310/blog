(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{1106:function(t,n,s){"use strict";s.r(n);var a=s(14),e=Object(a.a)({},(function(){var t=this,n=t._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"_61-hystrix之服务熔断总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_61-hystrix之服务熔断总结"}},[t._v("#")]),t._v(" 61_Hystrix之服务熔断总结")]),t._v(" "),n("p",[n("img",{attrs:{src:s(585),alt:"image-20211229104855442"}})]),t._v(" "),n("p",[t._v("熔断类型")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("熔断打开：请求不再进行调用当前服务，内部设置时钟一般为MTTR(平均故障处理时间)，当打开时长达到所设时钟则进入半熔断状态。\n熔断关闭：熔断关闭不会对服务进行熔断。\n熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断。\n")])])]),n("p",[t._v("官网断路器流程图")]),t._v(" "),n("p",[n("img",{attrs:{src:s(586),alt:"image-20211229104925843"}})]),t._v(" "),n("p",[n("strong",[t._v("断路器在什么情况下开始起作用")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[t._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixCommand")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fallbackMethod "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"paymentCircuitBreaker_fallback"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("commandProperties "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixProperty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"circuitBreaker.enabled"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否开启断路器")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixProperty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"circuitBreaker.requestVolumeThreshold"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求次数")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixProperty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"circuitBreaker.sleepWindowInMilliseconds"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10000"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 时间窗口期 10s")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixProperty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"circuitBreaker.errorThresholdPercentage"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"60"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 失败率达到多少后跳闸 60%")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//10次中有60%  也就是6次失败,那么open断路器,等待10s后尝试重连")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//主业务")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//业务说明: 输入id< 0 报错  id>=0正常 生成流水号")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("paymentCircuitBreaker")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PathVariable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"******id 不能负数"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//hutool 插件, 在comment  jar包pom引入")]),t._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//IdUtil.simpleUUID(); 等价于   UUID.randomUUID().toString();")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" serialNumber "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IdUtil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("simpleUUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getName")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\\t"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"调用成功，流水号: "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" serialNumber"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//兜底方法")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("paymentCircuitBreaker_fallback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PathVariable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),t._v(" id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id 不能负数，请稍后再试，/(ㄒoㄒ)/~~   id: "')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("涉及到断路器的三个重要参数：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒。\n请求总数阀值：在快照时间窗内，必须满足请求总数阀值才有资格熔断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次,即使所有的请求都超时或其他原因失败，断路器都不会打开。\n错误百分比阀值：当请求总数在快照时间窗内超过了阀值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阀值情况下，这时候就会将断路器打开。\n")])])]),n("p",[t._v("断路器开启或者关闭的条件")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("到达以下阀值，断路器将会开启：\n    当满足一定的阀值的时候（默认10秒内超过20个请求次数)\n    当失败率达到一定的时候（默认10秒内超过50%的请求失败)\n\n当开启的时候，所有请求都不会进行转发\n\n一段时间之后（默认是5秒)，这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。\n")])])]),n("p",[t._v("断路器打开之后")]),t._v(" "),n("p",[t._v("1：再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback。通过断路器，实现了自动地发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。")]),t._v(" "),n("p",[t._v("2：原来的主逻辑要如何恢复呢？")]),t._v(" "),n("p",[t._v("对于这一问题，hystrix也为我们实现了自动恢复功能。")]),t._v(" "),n("p",[t._v("当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。")]),t._v(" "),n("p",[n("strong",[t._v("All配置")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('@HystrixCommand(fallbackMethod = "fallbackMethod", \n                groupKey = "strGroupCommand", \n                commandKey = "strCommand", \n                threadPoolKey = "strThreadPool",\n                \n                commandProperties = {\n                    // 设置隔离策略，THREAD 表示线程池 SEMAPHORE：信号池隔离\n                    @HystrixProperty(name = "execution.isolation.strategy", value = "THREAD"),\n                    // 当隔离策略选择信号池隔离的时候，用来设置信号池的大小（最大并发数）\n                    @HystrixProperty(name = "execution.isolation.semaphore.maxConcurrentRequests", value = "10"),\n                    // 配置命令执行的超时时间\n                    @HystrixProperty(name = "execution.isolation.thread.timeoutinMilliseconds", value = "10"),\n                    // 是否启用超时时间\n                    @HystrixProperty(name = "execution.timeout.enabled", value = "true"),\n                    // 执行超时的时候是否中断\n                    @HystrixProperty(name = "execution.isolation.thread.interruptOnTimeout", value = "true"),\n                    \n                    // 执行被取消的时候是否中断\n                    @HystrixProperty(name = "execution.isolation.thread.interruptOnCancel", value = "true"),\n                    // 允许回调方法执行的最大并发数\n                    @HystrixProperty(name = "fallback.isolation.semaphore.maxConcurrentRequests", value = "10"),\n                    // 服务降级是否启用，是否执行回调函数\n                    @HystrixProperty(name = "fallback.enabled", value = "true"),\n                    // 是否启用断路器\n                    @HystrixProperty(name = "circuitBreaker.enabled", value = "true"),\n                    // 该属性用来设置在滚动时间窗中，断路器熔断的最小请求数。例如，默认该值为 20 的时候，如果滚动时间窗（默认10秒）内仅收到了19个请求， 即使这19个请求都失败了，断路器也不会打开。\n                    @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "20"),\n                    \n                    // 该属性用来设置在滚动时间窗中，表示在滚动时间窗中，在请求数量超过 circuitBreaker.requestVolumeThreshold 的情况下，如果错误请求数的百分比超过50, 就把断路器设置为 "打开" 状态，否则就设置为 "关闭" 状态。\n                    @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),\n                    // 该属性用来设置当断路器打开之后的休眠时间窗。 休眠时间窗结束之后，会将断路器置为 "半开" 状态，尝试熔断的请求命令，如果依然失败就将断路器继续设置为 "打开" 状态，如果成功就设置为 "关闭" 状态。\n                    @HystrixProperty(name = "circuitBreaker.sleepWindowinMilliseconds", value = "5000"),\n                    // 断路器强制打开\n                    @HystrixProperty(name = "circuitBreaker.forceOpen", value = "false"),\n                    // 断路器强制关闭\n                    @HystrixProperty(name = "circuitBreaker.forceClosed", value = "false"),\n                    // 滚动时间窗设置，该时间用于断路器判断健康度时需要收集信息的持续时间\n                    @HystrixProperty(name = "metrics.rollingStats.timeinMilliseconds", value = "10000"),\n                    \n                    // 该属性用来设置滚动时间窗统计指标信息时划分"桶"的数量，断路器在收集指标信息的时候会根据设置的时间窗长度拆分成多个 "桶" 来累计各度量值，每个"桶"记录了一段时间内的采集指标。\n                    // 比如 10 秒内拆分成 10 个"桶"收集这样，所以 timeinMilliseconds 必须能被 numBuckets 整除。否则会抛异常\n                    @HystrixProperty(name = "metrics.rollingStats.numBuckets", value = "10"),\n                    // 该属性用来设置对命令执行的延迟是否使用百分位数来跟踪和计算。如果设置为 false, 那么所有的概要统计都将返回 -1。\n                    @HystrixProperty(name = "metrics.rollingPercentile.enabled", value = "false"),\n                    // 该属性用来设置百分位统计的滚动窗口的持续时间，单位为毫秒。\n                    @HystrixProperty(name = "metrics.rollingPercentile.timeInMilliseconds", value = "60000"),\n                    // 该属性用来设置百分位统计滚动窗口中使用 “ 桶 ”的数量。\n                    @HystrixProperty(name = "metrics.rollingPercentile.numBuckets", value = "60000"),\n                    // 该属性用来设置在执行过程中每个 “桶” 中保留的最大执行次数。如果在滚动时间窗内发生超过该设定值的执行次数，\n                    // 就从最初的位置开始重写。例如，将该值设置为100, 滚动窗口为10秒，若在10秒内一个 “桶 ”中发生了500次执行，\n                    // 那么该 “桶” 中只保留 最后的100次执行的统计。另外，增加该值的大小将会增加内存量的消耗，并增加排序百分位数所需的计算时间。\n                    @HystrixProperty(name = "metrics.rollingPercentile.bucketSize", value = "100"),\n                    \n                    // 该属性用来设置采集影响断路器状态的健康快照（请求的成功、 错误百分比）的间隔等待时间。\n                    @HystrixProperty(name = "metrics.healthSnapshot.intervalinMilliseconds", value = "500"),\n                    // 是否开启请求缓存\n                    @HystrixProperty(name = "requestCache.enabled", value = "true"),\n                    // HystrixCommand的执行和事件是否打印日志到 HystrixRequestLog 中\n                    @HystrixProperty(name = "requestLog.enabled", value = "true"),\n\n                },\n                threadPoolProperties = {\n                    // 该参数用来设置执行命令线程池的核心线程数，该值也就是命令执行的最大并发量\n                    @HystrixProperty(name = "coreSize", value = "10"),\n                    // 该参数用来设置线程池的最大队列大小。当设置为 -1 时，线程池将使用 SynchronousQueue 实现的队列，否则将使用 LinkedBlockingQueue 实现的队列。\n                    @HystrixProperty(name = "maxQueueSize", value = "-1"),\n                    // 该参数用来为队列设置拒绝阈值。 通过该参数， 即使队列没有达到最大值也能拒绝请求。\n                    // 该参数主要是对 LinkedBlockingQueue 队列的补充,因为 LinkedBlockingQueue 队列不能动态修改它的对象大小，而通过该属性就可以调整拒绝请求的队列大小了。\n                    @HystrixProperty(name = "queueSizeRejectionThreshold", value = "5"),\n                }\n               )\npublic String doSomething() {\n\t...\n}\n\n')])])])])}),[],!1,null,null,null);n.default=e.exports},585:function(t,n,s){t.exports=s.p+"assets/img/20211229104902.2285a7c2.png"},586:function(t,n,s){t.exports=s.p+"assets/img/20211229104925.4b2874a3.png"}}]);