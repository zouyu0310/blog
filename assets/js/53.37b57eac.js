(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{320:function(a,s,t){a.exports=t.p+"assets/img/04.f849b60f.png"},321:function(a,s,t){a.exports=t.p+"assets/img/05.83551c5b.png"},758:function(a,s,t){"use strict";t.r(s);var r=t(14),_=Object(r.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"mysql运维实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql运维实践"}},[a._v("#")]),a._v(" MySQL运维实践")]),a._v(" "),s("h2",{attrs:{id:"_5-1-mysql日志系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-mysql日志系统"}},[a._v("#")]),a._v(" 5.1-MySQL日志系统")]),a._v(" "),s("h3",{attrs:{id:"什么是日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是日志"}},[a._v("#")]),a._v(" 什么是日志")]),a._v(" "),s("ul",[s("li",[a._v("日志(log)是一种顺序记录事件流水的文件")]),a._v(" "),s("li",[a._v("记录计算机程序运行过程中发生了什么")]),a._v(" "),s("li",[a._v("多种多样的用途\n"),s("ul",[s("li",[a._v("帮助分析程序问题")]),a._v(" "),s("li",[a._v("分析服务请求的特征、流量等")]),a._v(" "),s("li",[a._v("判断工作是否成功执行")]),a._v(" "),s("li",[a._v("等等……")])])])]),a._v(" "),s("h3",{attrs:{id:"mysql日志的分类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql日志的分类"}},[a._v("#")]),a._v(" MySQL日志的分类")]),a._v(" "),s("ul",[s("li",[a._v("服务器日志\n"),s("ul",[s("li",[a._v("记录进程启动运行过程中的特殊事件，帮助分析MySQL服务遇到的问题")]),a._v(" "),s("li",[a._v("根据需求抓取特定的SQL语句，追踪性能可能存在的问题的业务SQL")])])]),a._v(" "),s("li",[a._v("事务日志\n"),s("ul",[s("li",[a._v("记录应用程序对数据的所有更改")]),a._v(" "),s("li",[a._v("可用于数据恢复")]),a._v(" "),s("li",[a._v("可用于实例间数据同步")])])])]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[a._v("分类")]),a._v(" "),s("th",{staticStyle:{"text-align":"left"}},[a._v("日志名称")])])]),a._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[a._v("服务器日志")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("服务错误日志")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[a._v("服务器日志")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("慢查询日志")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[a._v("服务器日志")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("综合查询日志")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[a._v("事务日志")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("存储引擎事务日志")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[a._v("事务日志")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("二进制日志")])])])]),a._v(" "),s("h3",{attrs:{id:"服务错误日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务错误日志"}},[a._v("#")]),a._v(" 服务错误日志")]),a._v(" "),s("ul",[s("li",[a._v("记录实例启动运行过程中重要消息")]),a._v(" "),s("li",[a._v("配置参数\n"),s("ul",[s("li",[s("code",[a._v("log_error = /data/mysql_data/node-1/mysql.log")])])])]),a._v(" "),s("li",[a._v("内容并非全是错误消息")]),a._v(" "),s("li",[a._v("如果mysqld进程无法正常启动首先查看错误日志")])]),a._v(" "),s("h3",{attrs:{id:"慢查询日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志"}},[a._v("#")]),a._v(" 慢查询日志")]),a._v(" "),s("ul",[s("li",[a._v("记录执行时间超过一定阈值的SQL语句")]),a._v(" "),s("li",[a._v("配置参数")])]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[a._v("slow_query_log "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\nslow_query_log_file "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("mysql_data"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("node"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("log\nlong_query_time "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n")])])]),s("ul",[s("li",[a._v("用于分析系统中可能存在性能问题的SQL")])]),a._v(" "),s("h3",{attrs:{id:"综合查询日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#综合查询日志"}},[a._v("#")]),a._v(" 综合查询日志")]),a._v(" "),s("ul",[s("li",[a._v("如果开启将会记录系统中所有SQL语句")]),a._v(" "),s("li",[a._v("配置参数")])]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[a._v("general_log "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\ngeneral_log_file "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("mysql_data"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("node"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("log\n")])])]),s("ul",[s("li",[a._v("偶尔用于帮助分析系统问题，对性能有影响")])]),a._v(" "),s("h3",{attrs:{id:"查询日志的输出与文件切换"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询日志的输出与文件切换"}},[a._v("#")]),a._v(" 查询日志的输出与文件切换")]),a._v(" "),s("ul",[s("li",[a._v("日志输出参数")])]),a._v(" "),s("p",[s("code",[a._v("log_output={file|table|none}")])]),a._v(" "),s("ul",[s("li",[a._v("如果日志文件过大，可以定期截断并切换新文件")])]),a._v(" "),s("p",[s("code",[a._v("flush log;")])]),a._v(" "),s("h3",{attrs:{id:"存储引擎事务日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存储引擎事务日志"}},[a._v("#")]),a._v(" 存储引擎事务日志")]),a._v(" "),s("ul",[s("li",[a._v("部分存储引擎拥有重做日志(redo log)")]),a._v(" "),s("li",[a._v("如InnoDB, TokuDB等WAL(Write Ahead Log)机制存储引擎")]),a._v(" "),s("li",[a._v("日志随着事务commit优先持久化，确保异常恢复不丢数据")]),a._v(" "),s("li",[a._v("日志顺序写性能较好")])]),a._v(" "),s("h3",{attrs:{id:"innodb事务日志重用机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb事务日志重用机制"}},[a._v("#")]),a._v(" InnoDB事务日志重用机制")]),a._v(" "),s("ul",[s("li",[a._v("InnoDB事务日志采用两组文件交替重用")])]),a._v(" "),s("h3",{attrs:{id:"二进制日志binlog"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二进制日志binlog"}},[a._v("#")]),a._v(" 二进制日志binlog")]),a._v(" "),s("ul",[s("li",[a._v("binlog (binary log)")]),a._v(" "),s("li",[a._v("记录数据引起数据变化的SQL语句或数据逻辑变化的内容")]),a._v(" "),s("li",[a._v("MySQL服务层记录，无关存储引擎")]),a._v(" "),s("li",[a._v("binlog的主要作用：\n"),s("ul",[s("li",[a._v("基于备份恢复数据")]),a._v(" "),s("li",[a._v("数据库主从同步")]),a._v(" "),s("li",[a._v("挖掘分析SQL语句")])])])]),a._v(" "),s("h3",{attrs:{id:"开启binlog"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启binlog"}},[a._v("#")]),a._v(" 开启binlog")]),a._v(" "),s("ul",[s("li",[a._v("主要参数")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("log_bin = c:/tmp/mylog/mysql-bin\nsql_log_bin = 1\nsync_binlog = 1\n")])])]),s("ul",[s("li",[a._v("查看binlog")])]),a._v(" "),s("p",[s("code",[a._v("show binary logs;")])]),a._v(" "),s("h3",{attrs:{id:"binlog管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#binlog管理"}},[a._v("#")]),a._v(" binlog管理")]),a._v(" "),s("ul",[s("li",[a._v("主要参数")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("max_binlog_size = 100MB\nexpire_logs_days = 7\n")])])]),s("ul",[s("li",[s("p",[a._v("binlog始终生成新文件，不会重用")])]),a._v(" "),s("li",[s("p",[a._v("手工清理binlog")])])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("purge binary logs to 'mysql-bin.000009';\npurge binary logs before '2016-4-2 21:00:40'\n")])])]),s("h3",{attrs:{id:"查看binlog内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看binlog内容"}},[a._v("#")]),a._v(" 查看binlog内容")]),a._v(" "),s("ul",[s("li",[a._v("日志")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("show binlog events in 'mysql-bin.000011';\nshow binlog events in 'mysql-bin.000011' from 60 limit 3;\n")])])]),s("ul",[s("li",[a._v("mysqlbinlog工具")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("mysqlbinlog c:/tmp/mylog/mysql-bin.000001\n--start-datetime | --stop-datetime\n--start-position | --stop-position\n")])])]),s("h3",{attrs:{id:"binlog格式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#binlog格式"}},[a._v("#")]),a._v(" binlog格式")]),a._v(" "),s("ul",[s("li",[a._v("主要参数")])]),a._v(" "),s("p",[s("code",[a._v("binlog_format = {ROW|STATEMENT|MIXED}")])]),a._v(" "),s("ul",[s("li",[a._v("查看row模式的binlog内容")])]),a._v(" "),s("p",[s("code",[a._v("mysqlbinlog --base64-output=decode-rows -v c:/tmp/mylpg/mysql-bin.000001")])]),a._v(" "),s("h2",{attrs:{id:"_5-2-mysql数据备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-mysql数据备份"}},[a._v("#")]),a._v(" 5.2-MySQL数据备份")]),a._v(" "),s("h3",{attrs:{id:"基本指数-备份用途"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本指数-备份用途"}},[a._v("#")]),a._v(" 基本指数 - 备份用途")]),a._v(" "),s("ul",[s("li",[a._v("数据备灾\n"),s("ul",[s("li",[a._v("应对硬件故障数据丢失")]),a._v(" "),s("li",[a._v("应对人为或程序bug导致数据删除")])])]),a._v(" "),s("li",[a._v("制作镜像库以供服务\n"),s("ul",[s("li",[a._v("需要将数据迁移、统计分析等用处")]),a._v(" "),s("li",[a._v("需要为线上数据建立一个镜像")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-备份内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-备份内容"}},[a._v("#")]),a._v(" 基本知识 - 备份内容")]),a._v(" "),s("ul",[s("li",[a._v("数据\n"),s("ul",[s("li",[a._v("数据文件或文本格式数据")])])]),a._v(" "),s("li",[a._v("操作日志(binlog)\n"),s("ul",[s("li",[a._v("数据库变更日志")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-冷备份与热备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-冷备份与热备份"}},[a._v("#")]),a._v(" 基本知识 - 冷备份与热备份")]),a._v(" "),s("ul",[s("li",[a._v("冷备份\n"),s("ul",[s("li",[a._v("关闭数据库服务，完整拷贝数据文件")])])]),a._v(" "),s("li",[a._v("热备份\n"),s("ul",[s("li",[a._v("在不影响数据库读写服务的情况下备份数据库")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-物理备份与逻辑备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-物理备份与逻辑备份"}},[a._v("#")]),a._v(" 基本知识 - 物理备份与逻辑备份")]),a._v(" "),s("ul",[s("li",[a._v("物理备份\n"),s("ul",[s("li",[a._v("以数据页的形式拷贝数据")])])]),a._v(" "),s("li",[a._v("逻辑备份\n"),s("ul",[s("li",[a._v("导出为裸数据或者SQL(insert)语句")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-本地备份与远程备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-本地备份与远程备份"}},[a._v("#")]),a._v(" 基本知识 - 本地备份与远程备份")]),a._v(" "),s("ul",[s("li",[a._v("本地备份\n"),s("ul",[s("li",[a._v("在数据库服务器本地进行备份")])])]),a._v(" "),s("li",[a._v("远程备份\n"),s("ul",[s("li",[a._v("远程连接数据库进行备份")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-全量备份与增量备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-全量备份与增量备份"}},[a._v("#")]),a._v(" 基本知识 - 全量备份与增量备份")]),a._v(" "),s("ul",[s("li",[a._v("全量备份\n"),s("ul",[s("li",[a._v("备份完整的数据库")])])]),a._v(" "),s("li",[a._v("增量备份\n"),s("ul",[s("li",[a._v("只备份上一次备份以来发生修改的数据")])])])]),a._v(" "),s("h3",{attrs:{id:"基本知识-备份周期"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本知识-备份周期"}},[a._v("#")]),a._v(" 基本知识 - 备份周期")]),a._v(" "),s("p",[a._v("考虑因素：")]),a._v(" "),s("ul",[s("li",[a._v("数据库大小(决定备份时间)")]),a._v(" "),s("li",[a._v("恢复速度要求(快速or慢速)")]),a._v(" "),s("li",[a._v("备份方式(全量or增量)")])]),a._v(" "),s("h3",{attrs:{id:"常用工具及用法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用工具及用法"}},[a._v("#")]),a._v(" 常用工具及用法")]),a._v(" "),s("ul",[s("li",[a._v("mysqldump - 逻辑备份，热备")]),a._v(" "),s("li",[a._v("xtrabackup - 物理备份， 热备")]),a._v(" "),s("li",[a._v("Lvm/zfs snapshot - 物理备份")]),a._v(" "),s("li",[a._v("mydumper - 逻辑备份，热备")]),a._v(" "),s("li",[a._v("cp - 物理备份，冷备")])]),a._v(" "),s("h3",{attrs:{id:"常用工具及用法-mysqldump"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用工具及用法-mysqldump"}},[a._v("#")]),a._v(" 常用工具及用法 - mysqldump")]),a._v(" "),s("p",[a._v("MySQL官方自带的命令行工具")]),a._v(" "),s("p",[a._v("主要示例：")]),a._v(" "),s("ul",[s("li",[a._v("演示使用mysqldump备份表、库、实例")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份所有数据库")]),a._v("\nmysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--socket")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/run/mysqld/mysqld.sock --all-databases "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dbbackup/all_db.sql\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份指定的数据库")]),a._v("\nmysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--socket")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/run/mysqld/mysqld.sock "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--databases")]),a._v(" db2 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dbbackup/db2.sql\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份单个表")]),a._v("\nmysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--socket")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/run/mysqld/mysqld.sock db2 t1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("/dbbackup/db2_t1.sql\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 还原表")]),a._v("\nmysql "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("source")]),a._v(" /dbbackup/db2_t1.sql\n")])])]),s("ul",[s("li",[a._v("演示使用mysqldump制作一致性备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysqldump --single-transaction "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" --all-databases "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dbbackup/add_db_2.sql\n")])])]),s("ul",[s("li",[a._v("演示使用mysqldump远程备份一个数据库")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-utest")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-ptest")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-h192.168.0.68")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-P3306")]),a._v(" --all-databases "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dbbackup/remote_bakall.sql\n")])])]),s("ul",[s("li",[a._v("演示使用mysqldump导出数据为csv格式")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" --single-transaction --fields-terminated-by"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(", db1 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-T")]),a._v(" /tmp\n")])])]),s("h3",{attrs:{id:"常用工具及用法-xtrabackup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用工具及用法-xtrabackup"}},[a._v("#")]),a._v(" 常用工具及用法 - xtrabackup")]),a._v(" "),s("p",[a._v("特点：")]),a._v(" "),s("ul",[s("li",[a._v("开源，在线备份InnoDB表")]),a._v(" "),s("li",[a._v("支持限速备份，避免对业务造成影响")]),a._v(" "),s("li",[a._v("支持流备")]),a._v(" "),s("li",[a._v("支持增量备份")]),a._v(" "),s("li",[a._v("支持备份文件压缩与加密")]),a._v(" "),s("li",[a._v("支持并行备份与恢复，速度快")])]),a._v(" "),s("h3",{attrs:{id:"xtrabackup备份原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xtrabackup备份原理"}},[a._v("#")]),a._v(" xtrabackup备份原理")]),a._v(" "),s("ul",[s("li",[a._v("基于InnoDB的crash-recovery功能")]),a._v(" "),s("li",[a._v("备份期间允许用户读写，写请求产生redo日志")]),a._v(" "),s("li",[a._v("从磁盘上拷贝数据文件")]),a._v(" "),s("li",[a._v("从InnoDB redo log file实时拷贝走备份期间产生的所有redo日志")]),a._v(" "),s("li",[a._v("恢复的时候 数据文件 + redo日志 = 一致性数据")])]),a._v(" "),s("h3",{attrs:{id:"实用脚本innobackupex"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实用脚本innobackupex"}},[a._v("#")]),a._v(" 实用脚本innobackupex")]),a._v(" "),s("ul",[s("li",[a._v("开源Perl脚本，封装调用xtrabackup及一系列相关工具与OS操作，最终完成备份过程")]),a._v(" "),s("li",[a._v("支持备份InnoDB和其他引擎的表")]),a._v(" "),s("li",[a._v("备份一致性保证")])]),a._v(" "),s("h3",{attrs:{id:"innobackupex备份基本流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innobackupex备份基本流程"}},[a._v("#")]),a._v(" innobackupex备份基本流程")]),a._v(" "),s("p",[a._v("start xtrabackup_log -> copy .ibd; ibdata1 -> FLUSH TABLE WITH READ LOCK -> copy .FRM; MYD; MYI; misc files -> Get binary log position -> UNLOCK TABLES -> stop and copy xtrabackup_log")]),a._v(" "),s("h3",{attrs:{id:"innobackupex使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innobackupex使用"}},[a._v("#")]),a._v(" innobackupex使用")]),a._v(" "),s("p",[a._v("主要示例：")]),a._v(" "),s("ul",[s("li",[a._v("全量备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf /dbbackup\n")])])]),s("ul",[s("li",[a._v("增量备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--incremental")]),a._v(" --incremental-dir /dbbackup/2016-4-3_13:24:32 /dbbackup\n")])])]),s("ul",[s("li",[a._v("流方式备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--stream")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("xbstream /dbbackup/ "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dbbackup/stream.bak\n")])])]),s("ul",[s("li",[a._v("并行备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--parallel")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),a._v(" /dbbackup/\n")])])]),s("ul",[s("li",[a._v("限流备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--throttle")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" /dbbackup/\n")])])]),s("ul",[s("li",[a._v("压缩备份")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("123456")]),a._v(" --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/mysql/my.cnf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--compress")]),a._v(" --compress-thread "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),a._v(" /dbbackup/\n")])])]),s("h3",{attrs:{id:"如何制定备份策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何制定备份策略"}},[a._v("#")]),a._v(" 如何制定备份策略")]),a._v(" "),s("p",[a._v("需要考虑的因素")]),a._v(" "),s("ul",[s("li",[a._v("数据库是不是都是innodb引擎表 -> 备份方式，热备or冷备")]),a._v(" "),s("li",[a._v("数据量大小 -> 逻辑备份or物理备份，全量or增量")]),a._v(" "),s("li",[a._v("数据库本地磁盘空间十分充足 -> 备份到本地or远程")]),a._v(" "),s("li",[a._v("需要多块恢复 -> 备份频率 小时or天")])]),a._v(" "),s("h2",{attrs:{id:"_5-3-mysql数据恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-mysql数据恢复"}},[a._v("#")]),a._v(" 5.3-MySQL数据恢复")]),a._v(" "),s("h3",{attrs:{id:"什么时候需要恢复数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么时候需要恢复数据"}},[a._v("#")]),a._v(" 什么时候需要恢复数据")]),a._v(" "),s("ul",[s("li",[a._v("硬件故障(如磁盘损坏)")]),a._v(" "),s("li",[a._v("人为删除(如误删除数据、被黑)")]),a._v(" "),s("li",[a._v("业务回滚(如游戏bug需要回档)")]),a._v(" "),s("li",[a._v("正常需求(如部署镜像库、查看历史某时刻数据)")])]),a._v(" "),s("h3",{attrs:{id:"数据恢复的必要条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据恢复的必要条件"}},[a._v("#")]),a._v(" 数据恢复的必要条件")]),a._v(" "),s("ul",[s("li",[a._v("有效备份")]),a._v(" "),s("li",[a._v("完整的数据库操作日志(binlog)")])]),a._v(" "),s("h3",{attrs:{id:"数据恢复思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据恢复思路"}},[a._v("#")]),a._v(" 数据恢复思路")]),a._v(" "),s("ul",[s("li",[a._v("最新一次备份 + binlog恢复到故障时间点(适用于各种数据丢失场景)")]),a._v(" "),s("li",[a._v("挖掘最后一次备份到故障点之间的binlog获取相关SQL语句，构造反转SQL语句并应用到数据库(只是用于记录丢失，且binlog必须是row格式)")])]),a._v(" "),s("h3",{attrs:{id:"反转sql语句"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#反转sql语句"}},[a._v("#")]),a._v(" 反转SQL语句")]),a._v(" "),s("p",[a._v("例：")]),a._v(" "),s("p",[s("code",[a._v("t1(id primary key, a int)")])]),a._v(" "),s("p",[a._v("反转SQL语句：")]),a._v(" "),s("p",[s("code",[a._v("insert into t(id, a) values(1, 1)")]),a._v(" -> "),s("code",[a._v("delete t1 where id=1 and a=1")]),a._v(" "),s("code",[a._v("update t1 set a=5 where id=1")]),a._v(" -> "),s("code",[a._v("update t1 set a=1 where id=1")]),a._v(" "),s("code",[a._v("delete from t1 where id=1")]),a._v(" -> "),s("code",[a._v("insert into t(id, a) values(1, 1)")])]),a._v(" "),s("h3",{attrs:{id:"数据库恢复工具与命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库恢复工具与命令"}},[a._v("#")]),a._v(" 数据库恢复工具与命令")]),a._v(" "),s("ul",[s("li",[a._v("mysqldump备份 -> source恢复")]),a._v(" "),s("li",[a._v("xtrabackup备份 -> xtrabackup恢复")]),a._v(" "),s("li",[a._v("binlog备份 -> mysqlbinlog恢复")])]),a._v(" "),s("h3",{attrs:{id:"详细示例讲解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#详细示例讲解"}},[a._v("#")]),a._v(" 详细示例讲解")]),a._v(" "),s("ul",[s("li",[a._v("恢复某几条误删数据")]),a._v(" "),s("li",[a._v("恢复误删表、库")]),a._v(" "),s("li",[a._v("将数据库恢复到指定时间点")])]),a._v(" "),s("h3",{attrs:{id:"恢复误删除数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恢复误删除数据"}},[a._v("#")]),a._v(" 恢复误删除数据")]),a._v(" "),s("p",[a._v("case：误操作，删除数据忘记带完整条件，执行"),s("code",[a._v("delete from user where age > 30 [and sex=male]")])]),a._v(" "),s("p",[a._v("需求：将被删除的数据还原")]),a._v(" "),s("p",[a._v("恢复前提：完整的数据库操作日志(binlog)")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("delete")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("from")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("user")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("where")]),a._v(" sex"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'female'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 首先需要找到binlog里的信息")]),a._v("\nmysqlbinlog "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-vv")]),a._v(" mysql-bin.000001\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 找出sql语句，然后写出反转sql语句")]),a._v("\n")])])]),s("h3",{attrs:{id:"恢复误删表、库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恢复误删表、库"}},[a._v("#")]),a._v(" 恢复误删表、库")]),a._v(" "),s("p",[a._v("case：业务被黑，表被删除了(drop teble user)")]),a._v(" "),s("p",[a._v("需求：将表恢复")]),a._v(" "),s("p",[a._v("前提：备份 + 备份以来完整binlog")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("innobackupex --apply-log /dbbackup/filename\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看binlog的位置点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" xtrabackup_binlog_info\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看结束点")]),a._v("\nmysqlbinlog "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-vv")]),a._v(" filename\n\nmysqlbinlog "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-vv")]),a._v(" --start-position"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2556990")]),a._v(" -- stop-position"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2776338")]),a._v("\nmysqlbinlog "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-vv")]),a._v(" --start-position"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2556990")]),a._v(" -- stop-position"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2776338")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" mysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p123456")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sock")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dbbackup/mysql_3309/mysqld.sock\n")])])]),s("h3",{attrs:{id:"课程小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#课程小结"}},[a._v("#")]),a._v(" 课程小结")]),a._v(" "),s("ul",[s("li",[a._v("恢复是已经非常苦逼的差事，尽量避免做。我们要做数据卫士而不是救火队员。(线上应该严格把控权限，数据变更操作应事先测试，操作时做好备份)")]),a._v(" "),s("li",[a._v("有效备份(+binlog)是重中之重，对数据库定期备份是必须的")]),a._v(" "),s("li",[a._v("备份是一切数据恢复的基础")])]),a._v(" "),s("h2",{attrs:{id:"_5-4-mysql线上部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-mysql线上部署"}},[a._v("#")]),a._v(" 5.4-MySQL线上部署")]),a._v(" "),s("h3",{attrs:{id:"mysql线上部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql线上部署"}},[a._v("#")]),a._v(" MySQL线上部署")]),a._v(" "),s("p",[a._v("考虑因素：")]),a._v(" "),s("ul",[s("li",[a._v("版本选择， 5.1、5.5还是5.6？")]),a._v(" "),s("li",[a._v("分支选择，官方社区版？ percona server？ Mariadb？")]),a._v(" "),s("li",[a._v("安装方式，包安装？二进制包安装？源码安装？")]),a._v(" "),s("li",[a._v("路径配置，参数配置(尽量模板化、标准化)")]),a._v(" "),s("li",[a._v("一个实例多个库 or 多个实例单个库？")])]),a._v(" "),s("h3",{attrs:{id:"二进制安装mysql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二进制安装mysql"}},[a._v("#")]),a._v(" 二进制安装MySQL")]),a._v(" "),s("ul",[s("li",[a._v("下载软件包")]),a._v(" "),s("li",[a._v("解压放到指定目录(比如/usr/local)")]),a._v(" "),s("li",[a._v("将MySQL目录放到PATH中")]),a._v(" "),s("li",[a._v("初始化实例，编辑配置文件并启动")]),a._v(" "),s("li",[a._v("账户安全设置")])]),a._v(" "),s("h3",{attrs:{id:"编译安装mysql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编译安装mysql"}},[a._v("#")]),a._v(" 编译安装MySQL")]),a._v(" "),s("ul",[s("li",[a._v("下载MySQL源码安装包")]),a._v(" "),s("li",[a._v("安装必要包(make cmake bison-devel ncurses-devel build-essential)")]),a._v(" "),s("li",[a._v("Cmake配置MySQL编译选项，可以定制需要安装的功能")]),a._v(" "),s("li",[a._v("make && make install")]),a._v(" "),s("li",[a._v("初始化实例，编辑配置文件并启动")]),a._v(" "),s("li",[a._v("账户安全设置")])]),a._v(" "),s("h3",{attrs:{id:"mysql升级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql升级"}},[a._v("#")]),a._v(" MySQL升级")]),a._v(" "),s("ul",[s("li",[a._v("下载MySQL5.6安装包并配置MySQL5.6安装包安装路径")]),a._v(" "),s("li",[a._v("关闭MySQL5.5实例，修改部分参数，使用MySQL5.6软件启动")]),a._v(" "),s("li",[a._v("执行MySQL5.6路径下mysql_upgrade脚本")]),a._v(" "),s("li",[a._v("验证是否成功升级")])]),a._v(" "),s("h3",{attrs:{id:"mysql多实例安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql多实例安装"}},[a._v("#")]),a._v(" MySQL多实例安装")]),a._v(" "),s("ul",[s("li",[a._v("部署好mysql软件")]),a._v(" "),s("li",[a._v("编辑多个配置文件，初始化多个实例")]),a._v(" "),s("li",[a._v("启动MySQL实例")])]),a._v(" "),s("h3",{attrs:{id:"mysql多实例部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql多实例部署"}},[a._v("#")]),a._v(" MySQL多实例部署")]),a._v(" "),s("p",[a._v("为啥多实例部署？")]),a._v(" "),s("ul",[s("li",[a._v("充分利用系统资源")]),a._v(" "),s("li",[a._v("资源隔离")]),a._v(" "),s("li",[a._v("业务、模块隔离")])]),a._v(" "),s("h3",{attrs:{id:"mysql线上安装小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql线上安装小结"}},[a._v("#")]),a._v(" MySQL线上安装小结")]),a._v(" "),s("ul",[s("li",[a._v("根据需求选择合适的版本以及分支，建议使用或升级到较高版本5.5或5.6")]),a._v(" "),s("li",[a._v("如果需要定制MySQL功能的话，可以考虑编译安装，否则的话建议使用二进制包安装，比较省事")]),a._v(" "),s("li",[a._v("根据机器配置选择部署多个MySQL实例还是单个实例，机器配置非常好的话，建议部署多实例")])]),a._v(" "),s("h2",{attrs:{id:"_5-5-mysql主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-mysql主从复制"}},[a._v("#")]),a._v(" 5.5-MySQL主从复制")]),a._v(" "),s("h3",{attrs:{id:"mysql主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制"}},[a._v("#")]),a._v(" MySQL主从复制")]),a._v(" "),s("ul",[s("li",[a._v("一主一从")]),a._v(" "),s("li",[a._v("主主复制")]),a._v(" "),s("li",[a._v("一主多从")]),a._v(" "),s("li",[a._v("多主一从")]),a._v(" "),s("li",[a._v("联级复制")])]),a._v(" "),s("h3",{attrs:{id:"mysql主从复制用途"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制用途"}},[a._v("#")]),a._v(" MySQL主从复制用途")]),a._v(" "),s("ul",[s("li",[a._v("实时灾备，用于故障切换")]),a._v(" "),s("li",[a._v("读写分离，提供查询服务")]),a._v(" "),s("li",[a._v("备份，避免影响业务")])]),a._v(" "),s("h3",{attrs:{id:"mysql主从复制部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制部署"}},[a._v("#")]),a._v(" MySQL主从复制部署")]),a._v(" "),s("p",[a._v("主从部署必要条件")]),a._v(" "),s("ul",[s("li",[a._v("主库开启binlog日志(设置log-bin参数)")]),a._v(" "),s("li",[a._v("主从server-id不同")]),a._v(" "),s("li",[a._v("从库服务器能连通主库")])]),a._v(" "),s("p",[a._v("主从部署步骤：")]),a._v(" "),s("ul",[s("li",[a._v("备份还原(mysqldump或xtrabackup)")]),a._v(" "),s("li",[a._v("授权(grant replication slave on "),s("em",[a._v(".")]),a._v(")")]),a._v(" "),s("li",[a._v("配置复制，并启动(change master to)")]),a._v(" "),s("li",[a._v("查看主从复制信息(show slave status\\G)")])]),a._v(" "),s("h3",{attrs:{id:"mysql复制存在的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql复制存在的问题"}},[a._v("#")]),a._v(" MySQL复制存在的问题")]),a._v(" "),s("p",[a._v("存在的问题")]),a._v(" "),s("ul",[s("li",[a._v("主机宕机后，数据可能丢失")]),a._v(" "),s("li",[a._v("从库只有一个sql thread，主库写压力大，复制很可能延时")])]),a._v(" "),s("p",[a._v("解决方法：")]),a._v(" "),s("ul",[s("li",[a._v("半同步复制")]),a._v(" "),s("li",[a._v("并行复制")])]),a._v(" "),s("h3",{attrs:{id:"mysql-semi-sync-半同步复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql-semi-sync-半同步复制"}},[a._v("#")]),a._v(" MySQL semi-sync(半同步复制)")]),a._v(" "),s("p",[a._v("半同步复制")]),a._v(" "),s("ul",[s("li",[a._v("5.5集成到MySQL，以插件形式存在，需要单独安装")]),a._v(" "),s("li",[a._v("确保事务提交后binlog至少传输到一个从库")]),a._v(" "),s("li",[a._v("不保证从库应用完这个事务的binlog")]),a._v(" "),s("li",[a._v("性能有一定的降低，响应时间更长")]),a._v(" "),s("li",[a._v("网络异常或从库宕机，卡住主库，直到超时或从库恢复")])]),a._v(" "),s("h3",{attrs:{id:"mysql异步复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql异步复制"}},[a._v("#")]),a._v(" MySQL异步复制")]),a._v(" "),s("p",[s("img",{attrs:{src:t(320),alt:"异步复制"}})]),a._v(" "),s("h3",{attrs:{id:"mysql-semi-sync-半同步复制-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql-semi-sync-半同步复制-2"}},[a._v("#")]),a._v(" MySQL semi-sync(半同步复制)")]),a._v(" "),s("p",[s("img",{attrs:{src:t(321),alt:"半同步复制"}})]),a._v(" "),s("h3",{attrs:{id:"配置mysql半同步复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置mysql半同步复制"}},[a._v("#")]),a._v(" 配置MySQL半同步复制")]),a._v(" "),s("p",[a._v("只需一次：")]),a._v(" "),s("p",[a._v("主库：")]),a._v(" "),s("p",[s("code",[a._v("INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';")])]),a._v(" "),s("p",[a._v("从库：")]),a._v(" "),s("p",[s("code",[a._v("INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';")])]),a._v(" "),s("p",[a._v("动态设置：")]),a._v(" "),s("p",[a._v("主库：")]),a._v(" "),s("p",[s("code",[a._v("SET GLOBAL rpl_semi_sync_master_enabled=1;")]),a._v(" "),s("code",[a._v("SET GLOBAL rpl_semi_sync_master_timeout=N;")]),a._v(" master 延迟切异步")]),a._v(" "),s("p",[a._v("从库：")]),a._v(" "),s("p",[s("code",[a._v("SET GLOBAL rpl_semi_sync_slave_enabled=1;")])]),a._v(" "),s("h3",{attrs:{id:"配置mysql并行复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置mysql并行复制"}},[a._v("#")]),a._v(" 配置MySQL并行复制")]),a._v(" "),s("p",[a._v("并行复制")]),a._v(" "),s("ul",[s("li",[a._v("社区版5.6中新增")]),a._v(" "),s("li",[a._v("并行是指从库多线程apply binlog")]),a._v(" "),s("li",[a._v("库级别并行应用binlog，同一个数据库更改还是串行的(5.7版并行复制基于事务组)")])]),a._v(" "),s("p",[a._v("设置")]),a._v(" "),s("p",[s("code",[a._v("set global slave_parallel_workers=10;")]),a._v(" 设置sql线程数为10")]),a._v(" "),s("h3",{attrs:{id:"联级复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#联级复制"}},[a._v("#")]),a._v(" 联级复制")]),a._v(" "),s("p",[a._v("A -> B -> C")]),a._v(" "),s("p",[a._v("B中添加参数：\nlog_slave_updates\nB将把A的binlog记录到自己的binlog日志中")]),a._v(" "),s("h3",{attrs:{id:"复制监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#复制监控"}},[a._v("#")]),a._v(" 复制监控")]),a._v(" "),s("p",[a._v("查询从库状态：")]),a._v(" "),s("p",[s("code",[a._v("show slave status\\G")])]),a._v(" "),s("h3",{attrs:{id:"复制出错处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#复制出错处理"}},[a._v("#")]),a._v(" 复制出错处理")]),a._v(" "),s("p",[a._v("常见：1062(主键冲突) 1032(记录不存在)\n解决：手动处理\n或：\n跳过复制出错\n"),s("code",[a._v("set global sql_slave_skip_counter=1")])]),a._v(" "),s("h3",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("ul",[s("li",[a._v("MySQL主从复制是MySQL高可用性、高性能(负载均衡)的基础")]),a._v(" "),s("li",[a._v("简单、灵活，部署方式多样，可以根据不同业务场景部署不同复制结构")]),a._v(" "),s("li",[a._v("MySQL主从复制目前也存在一些问题，可以根据需要部署复制增强功能来解决问题")]),a._v(" "),s("li",[a._v("复制过程中应该时刻监控复制状态，复制出错或延时可能给系统造成影响")]),a._v(" "),s("li",[a._v("MySQL复制是MySQL数据库工程师必知必会的一项基本技能")])]),a._v(" "),s("h2",{attrs:{id:"_5-6-mysql日常运维"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-mysql日常运维"}},[a._v("#")]),a._v(" 5.6-MySQL日常运维")]),a._v(" "),s("h3",{attrs:{id:"dba运维工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dba运维工作"}},[a._v("#")]),a._v(" DBA运维工作")]),a._v(" "),s("p",[a._v("日常")]),a._v(" "),s("ul",[s("li",[a._v("导数据、数据修改、表结构变更")]),a._v(" "),s("li",[a._v("加权限、问题处理\n其他")]),a._v(" "),s("li",[a._v("数据库选型部署、设计、监控、备份、优化等")])]),a._v(" "),s("h3",{attrs:{id:"导数据及注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#导数据及注意事项"}},[a._v("#")]),a._v(" 导数据及注意事项")]),a._v(" "),s("ul",[s("li",[a._v("数据最终形式(csv、sql文本 还是直接导入某库中)")]),a._v(" "),s("li",[a._v("导数据方法(mysqldump、select into outfile)")]),a._v(" "),s("li",[a._v("导数据注意事项\n"),s("ul",[s("li",[a._v("导出为csv格式需要file权限，而且只能数据库本地导")]),a._v(" "),s("li",[a._v("避免锁库锁表(mysqldump使用——single-transaction选项不锁表)")]),a._v(" "),s("li",[a._v("避免对业务造成影响，尽量在镜像库做")])])])]),a._v(" "),s("h3",{attrs:{id:"数据修改及注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据修改及注意事项"}},[a._v("#")]),a._v(" 数据修改及注意事项")]),a._v(" "),s("ul",[s("li",[a._v("修改前切记做好备份")]),a._v(" "),s("li",[a._v("开事务做，修改完检查好了再提交")]),a._v(" "),s("li",[a._v("避免一次 修改大量数据，可以分批修改")]),a._v(" "),s("li",[a._v("避免业务高峰期做")])]),a._v(" "),s("h3",{attrs:{id:"表结构变更注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表结构变更注意事项"}},[a._v("#")]),a._v(" 表结构变更注意事项")]),a._v(" "),s("ul",[s("li",[a._v("在低峰期做")]),a._v(" "),s("li",[a._v("表结构变更是否会有锁？(5.6包含online ddl功能)")]),a._v(" "),s("li",[a._v("使用pt-online-schema-change完成表结构变更\n"),s("ul",[s("li",[a._v("可以避免主从延时")]),a._v(" "),s("li",[a._v("可以避免负载过高，可以限速")])])])]),a._v(" "),s("h3",{attrs:{id:"加权限及注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#加权限及注意事项"}},[a._v("#")]),a._v(" 加权限及注意事项")]),a._v(" "),s("ul",[s("li",[a._v("只给符合需求的最低权限")]),a._v(" "),s("li",[a._v("避免授权时修改密码")]),a._v(" "),s("li",[a._v("避免给应用账号super权限")])]),a._v(" "),s("h3",{attrs:{id:"问题处理-数据库慢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题处理-数据库慢"}},[a._v("#")]),a._v(" 问题处理(数据库慢？)")]),a._v(" "),s("ul",[s("li",[a._v("数据库慢在哪？")]),a._v(" "),s("li",[a._v("show processlist查看mysql连接信息")]),a._v(" "),s("li",[a._v("查看系统状态(iostat, top, vmstat)")])]),a._v(" "),s("h3",{attrs:{id:"小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[a._v("#")]),a._v(" 小结")]),a._v(" "),s("ul",[s("li",[a._v("日常工作比较简单，但是任何一个操作都可能影响线上服务")]),a._v(" "),s("li",[a._v("结合不同环境，不同要求选择最合适的方法处理")]),a._v(" "),s("li",[a._v("日常工作应该求稳不求快，保障线上稳定是DBA的最大责任")])]),a._v(" "),s("h2",{attrs:{id:"_5-7-mysql参数调优"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-mysql参数调优"}},[a._v("#")]),a._v(" 5.7-MySQL参数调优")]),a._v(" "),s("h3",{attrs:{id:"为什么要调整参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么要调整参数"}},[a._v("#")]),a._v(" 为什么要调整参数")]),a._v(" "),s("ul",[s("li",[a._v("不同服务器之间的配置、性能不一样")]),a._v(" "),s("li",[a._v("不同业务场景对数据的需求不一样")]),a._v(" "),s("li",[a._v("MySQL的默认参数只是个参考值，并不适合所有的应用场合")])]),a._v(" "),s("h3",{attrs:{id:"优化之前我们需要知道什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优化之前我们需要知道什么"}},[a._v("#")]),a._v(" 优化之前我们需要知道什么")]),a._v(" "),s("ul",[s("li",[a._v("服务器相关的配置")]),a._v(" "),s("li",[a._v("业务相关的情况")]),a._v(" "),s("li",[a._v("MySQL相关的配置")])]),a._v(" "),s("h3",{attrs:{id:"服务器上需要关注哪些"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务器上需要关注哪些"}},[a._v("#")]),a._v(" 服务器上需要关注哪些")]),a._v(" "),s("ul",[s("li",[a._v("硬件情况")]),a._v(" "),s("li",[a._v("操作系统版本")]),a._v(" "),s("li",[a._v("CPU、网卡节电模式")]),a._v(" "),s("li",[a._v("服务器numa设置")]),a._v(" "),s("li",[a._v("RAID卡缓存")])]),a._v(" "),s("h3",{attrs:{id:"磁盘调度策略-write-back"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#磁盘调度策略-write-back"}},[a._v("#")]),a._v(" 磁盘调度策略-write back")]),a._v(" "),s("ul",[s("li",[a._v("数据写入cache既返回，数据异步的从cache刷入存储介质")])]),a._v(" "),s("h3",{attrs:{id:"磁盘调度策略-write-through"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#磁盘调度策略-write-through"}},[a._v("#")]),a._v(" 磁盘调度策略-write through")]),a._v(" "),s("ul",[s("li",[a._v("数据同时写入cache和存储介质才返回写入成功")])]),a._v(" "),s("h3",{attrs:{id:"write-back-vs-write-through"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#write-back-vs-write-through"}},[a._v("#")]),a._v(" Write Back VS Write Through")]),a._v(" "),s("ul",[s("li",[a._v("write Back 性能优于 Write Through")]),a._v(" "),s("li",[a._v("Write Through 比 Write Back安全性高")])]),a._v(" "),s("h3",{attrs:{id:"raid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#raid"}},[a._v("#")]),a._v(" RAID")]),a._v(" "),s("ul",[s("li",[a._v("RAID Redundant Array of Independent Disks\n"),s("ul",[s("li",[a._v("生产环境里一般不太会用裸设备，通常会使用RAID卡对一块盘或多块盘做RAID")]),a._v(" "),s("li",[a._v("RAID卡会预留一块内存，来保证数据高效存储与读取")]),a._v(" "),s("li",[a._v("常见的RAID类型有:RAID1、RAID0、RAID10和RAID5")])])])]),a._v(" "),s("h3",{attrs:{id:"raid0-vs-raid1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#raid0-vs-raid1"}},[a._v("#")]),a._v(" RAID0 VS RAID1")]),a._v(" "),s("ul",[s("li",[a._v("RAID 0 - Block Striped. No Mirror. No Parity.")]),a._v(" "),s("li",[a._v("RAID 1 - Block Mirrored. No Stripe. No Parity.")])]),a._v(" "),s("h3",{attrs:{id:"raid5-vs-raid10"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#raid5-vs-raid10"}},[a._v("#")]),a._v(" RAID5 VS RAID10")]),a._v(" "),s("ul",[s("li",[a._v("RAID 5 - Block Striped. Distributed Parity.(至少三块盘，每块里有两个数据块和一个校验块)")]),a._v(" "),s("li",[a._v("RAID 10 - Block Mirrored.(每两块盘做RAID1，然后再按组做RAID0，至少四块盘)")])]),a._v(" "),s("h3",{attrs:{id:"raid如何保证数据安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#raid如何保证数据安全"}},[a._v("#")]),a._v(" RAID如何保证数据安全")]),a._v(" "),s("ul",[s("li",[a._v("BBU(Backup Battery Unit)\n"),s("ul",[s("li",[a._v("BBU保证在WB策略下，即使服务器发生掉电或者宕机，也能够将缓存数据写入到磁盘，从而保证数据的安全")])])])]),a._v(" "),s("h3",{attrs:{id:"mysql有哪些注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql有哪些注意事项"}},[a._v("#")]),a._v(" MySQL有哪些注意事项")]),a._v(" "),s("ul",[s("li",[a._v("MySQL的部署安装")]),a._v(" "),s("li",[a._v("MySQL的监控")]),a._v(" "),s("li",[a._v("MySQL参数调优")])]),a._v(" "),s("h3",{attrs:{id:"部署mysql的要求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署mysql的要求"}},[a._v("#")]),a._v(" 部署MySQL的要求")]),a._v(" "),s("ul",[s("li",[a._v("推荐的MySQL版本: >= MySQL5.5")]),a._v(" "),s("li",[a._v("推荐的MySQL存储引擎: InnoDB")])]),a._v(" "),s("h3",{attrs:{id:"系统调优的依据-监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#系统调优的依据-监控"}},[a._v("#")]),a._v(" 系统调优的依据：监控")]),a._v(" "),s("ul",[s("li",[a._v("实时监控MySQL的slow log")]),a._v(" "),s("li",[a._v("实时监控数据库服务器的负载情况")]),a._v(" "),s("li",[a._v("实时监控MySQL内部状态值")])]),a._v(" "),s("h3",{attrs:{id:"通常关注哪些mysql-status"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通常关注哪些mysql-status"}},[a._v("#")]),a._v(" 通常关注哪些MySQL Status")]),a._v(" "),s("ul",[s("li",[a._v("Com_Select/Update/Delete/Insert")]),a._v(" "),s("li",[a._v("Bytes_received/Bytes_sent")]),a._v(" "),s("li",[a._v("Buffer Pool Hit Rate")]),a._v(" "),s("li",[a._v("Threads_connected/Threads_created/Threads_running")])]),a._v(" "),s("h3",{attrs:{id:"mysql参数调优"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql参数调优"}},[a._v("#")]),a._v(" MySQL参数调优")]),a._v(" "),s("ul",[s("li",[a._v("为什么要调整MySQL的参数\n"),s("ul",[s("li",[a._v("MySQL是通用数据库，但业务是多变的，默认参数无法满足所有业务需求")]),a._v(" "),s("li",[a._v("MySQL内部一些参数是在MySQL一些很老的版本时候做的，可能之前是做限流和保护用的，但随着机器性能的提高，这些保护类的参数可能会成为性能瓶颈")])])])]),a._v(" "),s("h3",{attrs:{id:"读优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#读优化"}},[a._v("#")]),a._v(" 读优化")]),a._v(" "),s("ul",[s("li",[a._v("合理利用索引对MySQL查询性能至关重要")]),a._v(" "),s("li",[a._v("适当的调整参数也能提升查询性能")])]),a._v(" "),s("h3",{attrs:{id:"innodb-buffer-pool-size"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb-buffer-pool-size"}},[a._v("#")]),a._v(" innodb_buffer_pool_size")]),a._v(" "),s("ul",[s("li",[a._v("InnoDB存储引擎自己维护一块内存区域完成新老数据的替换")]),a._v(" "),s("li",[a._v("内存越大越能缓存更多的数据")])]),a._v(" "),s("h3",{attrs:{id:"innodb-thread-concurrency"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb-thread-concurrency"}},[a._v("#")]),a._v(" innodb_thread_concurrency")]),a._v(" "),s("ul",[s("li",[a._v("innoDB内部并发控制参数，设置为0代表不做控制")]),a._v(" "),s("li",[a._v("如果并发请求较多，参数设置较小，后进来的请求将会排队")])]),a._v(" "),s("h3",{attrs:{id:"写优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#写优化"}},[a._v("#")]),a._v(" 写优化")]),a._v(" "),s("ul",[s("li",[a._v("表结构设计上使用自增字段作为表的主键")]),a._v(" "),s("li",[a._v("只对合适的字段加索引，索引太多影响写入性能")]),a._v(" "),s("li",[a._v("监控服务器磁盘IO情况，如果写延迟较大则需要扩容")]),a._v(" "),s("li",[a._v("选择正确的MySQL版本，合理设置参数")])]),a._v(" "),s("h3",{attrs:{id:"哪些参数有助于提高写入性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#哪些参数有助于提高写入性能"}},[a._v("#")]),a._v(" 哪些参数有助于提高写入性能")]),a._v(" "),s("ul",[s("li",[a._v("innoDB_flush_log_at_trx_commit && sync_binlog")]),a._v(" "),s("li",[a._v("innodb log file size")]),a._v(" "),s("li",[a._v("innodb_io_capacity")]),a._v(" "),s("li",[a._v("innodb insert buffer")])]),a._v(" "),s("h3",{attrs:{id:"主要影响mysql写性能的两个参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要影响mysql写性能的两个参数"}},[a._v("#")]),a._v(" 主要影响MySQL写性能的两个参数")]),a._v(" "),s("ul",[s("li",[a._v("innoDB_flush_log_at_trx_commit")]),a._v(" "),s("li",[a._v("sync_binlog")])]),a._v(" "),s("h3",{attrs:{id:"innodb-flush-log-at-trx-commit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb-flush-log-at-trx-commit"}},[a._v("#")]),a._v(" innoDB_flush_log_at_trx_commit")]),a._v(" "),s("ul",[s("li",[a._v("控制InnoDB事务的刷新方式，一共有三个值：0,1,2\n"),s("ul",[s("li",[a._v("N=0 - 每隔一秒，把事务日志缓存区的数据写到日志文件中，以及把日志文件的数据刷新到磁盘上(高效，但不安全)")]),a._v(" "),s("li",[a._v("N=1 - 每个事务提交时候，把事务日志从缓存区写到日志文件中，并且刷新日志文件的数据到磁盘上，优先使用此模式保障数据安全性(低效，非常安全)")]),a._v(" "),s("li",[a._v("N=2 - 每事务提交的时候，把事务日志数据从缓存区写到日志文件中；每隔一秒，但不一定刷新到磁盘上，而是取决于操作系统的调度(高效，但不安全)")])])])]),a._v(" "),s("h3",{attrs:{id:"sync-binlog"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sync-binlog"}},[a._v("#")]),a._v(" sync_binlog")]),a._v(" "),s("ul",[s("li",[a._v("控制每次写入Binlog，是否都需要进行一次持久化")])]),a._v(" "),s("h3",{attrs:{id:"如何保证事务的安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何保证事务的安全"}},[a._v("#")]),a._v(" 如何保证事务的安全")]),a._v(" "),s("ul",[s("li",[a._v("innoDB_flush_log_at_trx_commit 和 sync_binlog都设为1")]),a._v(" "),s("li",[a._v("事务要和Binlog保证一致性")])]),a._v(" "),s("p",[a._v("(加锁)-> xa_prepare, Fsync -> Write And Fsync Binlog -> InnoDB Commit, Fsync ->(释放锁)")]),a._v(" "),s("h3",{attrs:{id:"串行有哪些问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#串行有哪些问题"}},[a._v("#")]),a._v(" 串行有哪些问题")]),a._v(" "),s("ul",[s("li",[a._v("SAS盘一般每秒只能有150~200个Fsync。")]),a._v(" "),s("li",[a._v("换算到数据库每秒只能执行50~60个事务")])]),a._v(" "),s("h3",{attrs:{id:"社区和官方的改进"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#社区和官方的改进"}},[a._v("#")]),a._v(" 社区和官方的改进")]),a._v(" "),s("ul",[s("li",[a._v("MariaDB提出改进，即使这两个参数都是1也能做到合并效果，性能得到了大幅提高。")]),a._v(" "),s("li",[a._v("官方吸收了MariaDB的思想，并在此基础上进行了改进，性能再次得到了提高")])]),a._v(" "),s("p",[a._v("Tips:")]),a._v(" "),s("ul",[s("li",[a._v("官方在MySQL5.6版本之后才做了这个优化")]),a._v(" "),s("li",[a._v("Percona和MariaDB版本在MySQL5.5已经包含了这个优化")])]),a._v(" "),s("h3",{attrs:{id:"innodb-redo-log"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb-redo-log"}},[a._v("#")]),a._v(" InnoDB Redo log")]),a._v(" "),s("ul",[s("li",[a._v("Write ahead Log")])]),a._v(" "),s("h3",{attrs:{id:"redo-log的作用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redo-log的作用"}},[a._v("#")]),a._v(" Redo log的作用")]),a._v(" "),s("ul",[s("li",[a._v("Redo log用在数据库崩溃会的故障恢复")])]),a._v(" "),s("h3",{attrs:{id:"redo-log有哪些问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redo-log有哪些问题"}},[a._v("#")]),a._v(" Redo log有哪些问题")]),a._v(" "),s("ul",[s("li",[a._v("如果写入频繁导致Redo log里对应的最老的数据脏页还没有刷新到磁盘，此时数据库将卡住，强制刷新脏页到磁盘")]),a._v(" "),s("li",[a._v("MySQL默认配置两个文件才10M，非常容易写满，生产环境中应适当调整大小。")])]),a._v(" "),s("h3",{attrs:{id:"innodb-io-capacity"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#innodb-io-capacity"}},[a._v("#")]),a._v(" innodb_io_capacity")]),a._v(" "),s("ul",[s("li",[a._v("InnoDB每次刷多少个脏页，决定InnoDB存储引擎的吞吐能力。")]),a._v(" "),s("li",[a._v("在SSD等高性能存储介质下，应该提高该参数以提高数据库的性能。")])]),a._v(" "),s("h3",{attrs:{id:"insert-buffer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#insert-buffer"}},[a._v("#")]),a._v(" Insert Buffer")]),a._v(" "),s("ul",[s("li",[a._v("顺序读写 VS 随机读写")]),a._v(" "),s("li",[a._v("随机请求性能远小于顺序请求")])]),a._v(" "),s("p",[a._v("尽可能多的随机请求合并为顺序请求才是提高数据库性能的关键")]),a._v(" "),s("ul",[s("li",[a._v("MySQL从5.1版本开始支持Insert Buffer")]),a._v(" "),s("li",[a._v("MySQL5.5版本之后同时支持update和delete的merge")]),a._v(" "),s("li",[a._v("Insert Buffer只对二级索引且非唯一索引有效")])]),a._v(" "),s("h3",{attrs:{id:"总结-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("ul",[s("li",[a._v("服务器配置要合理(内核版本、磁盘调度策略、RAID卡缓存)")]),a._v(" "),s("li",[a._v("完善的监控系统，提前发现问题")]),a._v(" "),s("li",[a._v("数据库版本要跟上，不要太新，也不要太老")]),a._v(" "),s("li",[a._v("数据库性能优化：\n"),s("ul",[s("li",[a._v("查询优化：索引优化为主，参数优化为辅")]),a._v(" "),s("li",[a._v("写入优化：业务优化为主，参数优化为辅")])])])])])}),[],!1,null,null,null);s.default=_.exports}}]);