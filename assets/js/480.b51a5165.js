(window.webpackJsonp=window.webpackJsonp||[]).push([[480],{1138:function(e,t,s){"use strict";s.r(t);var a=s(14),n=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"程序分发脚本操作文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#程序分发脚本操作文档"}},[e._v("#")]),e._v(" 程序分发脚本操作文档")]),e._v(" "),t("h3",{attrs:{id:"核心"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#核心"}},[e._v("#")]),e._v(" 核心")]),e._v(" "),t("p",[e._v("scp命令上传文件[目录]到其他服务器")]),e._v(" "),t("p",[e._v("举例：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("#10服务器传送文件到13服务器\nscp /java-project/qianyan-dbs-2021-05-13-17-15-37819.war root@172.31.241.239:/java-project/qianyan-dbs-2021-05-13-17-15-37819.war \n")])])]),t("h3",{attrs:{id:"使用步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用步骤"}},[e._v("#")]),e._v(" 使用步骤")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("CRT软件命令行进入10服务器/usr/local/scpShell路径下，找到升级dbs或者saas程序的脚本")]),e._v(" "),t("p",[e._v("cd /usr/local/scpShell")])])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/collab/7mxPOGrM4xKbqKa9/76fd33e8-c961-4bae-9ae0-4ffb92f797aa.png",alt:"image"}})]),e._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[e._v("修改host.txt文件中->10服务器新升级包名  和  目标服务器新升级包名")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/collab/7mxPOGrM4xKbqKa9/2712f36f-50e3-4ef4-a8ed-7dd6c84a2947.png",alt:"image"}})]),e._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[t("p",[e._v("CRT软件命令行在/usr/local/scpShell/dbs 或者 /usr/local/scpShell/saas下执行")]),e._v(" "),t("p",[e._v("./exeScp.sh")])]),e._v(" "),t("li",[t("p",[e._v("检查是否每条scp指令都执行成功")])])]),e._v(" "),t("h3",{attrs:{id:"完整流程图解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#完整流程图解"}},[e._v("#")]),e._v(" 完整流程图解")]),e._v(" "),t("ol",[t("li",[e._v("修改host.txt文件")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/collab/7mxPOGrM4xKbqKa9/c5399ca6-15de-4378-b941-a422b347842a.png",alt:"image"}})]),e._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[e._v("执行exeScp")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/collab/7mxPOGrM4xKbqKa9/b802f94b-5647-421c-a1d3-d09cf8c03a10.png",alt:"image"}})]),e._v(" "),t("h3",{attrs:{id:"实现-不涉及使用操作-仅供学习"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现-不涉及使用操作-仅供学习"}},[e._v("#")]),e._v(" 实现（不涉及使用操作，仅供学习）")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("安装expect")]),e._v(" "),t("p",[e._v("yum install expect")])]),e._v(" "),t("li",[t("p",[e._v("设置服务器地址，用户名，密码，源路径，目标路径")])])]),e._v(" "),t("p",[e._v("新建文件host.txt添加如下内容")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("192.168.0.135 root 密码 源路径 目标路径\n192.168.0.136 root 密码 源路径 目标路径\n192.168.0.137 root 密码 源路径 目标路径\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[e._v("添加expect执行脚本： cpExeShell.sh")])]),e._v(" "),t("p",[e._v("用于读取服务器账号配置的host.txt进行调用执行scp登录传输 密码 + 服务器IP")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v('#!/usr/bin/expect -f\nset HOST [lindex $argv 0]\nset USERNAME [lindex $argv 1]\nset PASSWD [lindex $argv 2]\nset source [lindex $argv 3]\nset target [lindex $argv 4]\nspawn scp -r $source $USERNAME@$HOST:$target\nexpect {\n"(yes/no)?"\n{\nsend "yes\\n"\nexpect "*assword:" { send "$PASSWD\\r" }\n}\n"*assword:"\n{\nsend "$PASSWD\\r"\n}\n}\nexpect eof\n')])])]),t("p",[e._v("expect是一个阻塞的switch，spawn执行一个命令后，expect会匹配返回值，并执行相应的操作。")]),e._v(" "),t("p",[e._v("expect格式")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v(' expect {\n    "string"  #-re可以正则匹配字符串\n    {\n    command\n    }\n    status\n    {\n    command\n    }\n    }\n')])])]),t("p",[e._v("（注意，expect右边必须有值，把括号写在下一行会报错！）")]),e._v(" "),t("p",[e._v("其中command可以是tcl语法命令，如puts，也可以是expect命令，如send,exp_continue,exit等等；而status是指expect的状态信息，如timeout，connected。")]),e._v(" "),t("p",[e._v("set  赋值，set host [lindex $argv0] 就是将参数0赋值给变量host，其中，[] 括起命令，执行括号内命令后返回结果，lindex是取列表中的某个参数，$argv则是参数列表。")]),e._v(" "),t("p",[e._v("while { } {command} while循环，和bash类似，while后面要留一个空格，右括号后面再留一个空格。")]),e._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[t("p",[e._v("添加shell脚本执行expect脚本：exeScp.sh")]),e._v(" "),t("p",[e._v("#!/bin/bash\ndir=/home\nwhile read line\ndo\nhost="),t("code",[e._v("echo $line| awk '{print $1}'")]),e._v("\nusername="),t("code",[e._v("echo $line | awk '{print $2}'")]),e._v("\npasswd="),t("code",[e._v("echo $line | awk '{print $3}'")]),e._v("\nsource="),t("code",[e._v("echo $line | awk '{print $4}'")]),e._v("\ntarget="),t("code",[e._v("echo $line | awk '{print $5}'")]),e._v("\n$dir/cpExeShell.sh $host $username $passwd $source $target\ndone < $dir/host.txt")])]),e._v(" "),t("li",[t("p",[e._v("赋予sh文件执行权限")]),e._v(" "),t("p",[e._v("chmod +x *.sh")])]),e._v(" "),t("li",[t("p",[e._v("执行")]),e._v(" "),t("p",[e._v("./exeScp.sh")])])]),e._v(" "),t("p",[e._v("说明：此处有三个文件均在home文件夹下，如需要发送其它文件夹到目标服务器，只需更改或增加host.txt文件中内容即可。（一般复制到home目录因为这个目录对外有可执行权限）")]),e._v(" "),t("p",[e._v("最终确定版本")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("#!/usr/bin/expect -f\nset HOST [lindex $argv 0]\nset USERNAME [lindex $argv 1]\n#set PASSWD [lindex $argv 2]\nset source [lindex $argv 2]\nset target [lindex $argv 3]\nspawn scp  $source $USERNAME@$HOST:$target\nexpect eof\n#expect eof 表示交互结束，退回到原用户\n\n#!/bin/bash\ndir=/usr/local/scpShell/dbs\nwhile read line || [[ -n ${line} ]]\ndo\nhost=`echo $line| awk '{print $1}'`\n#awk是用来提取列的主要工具\n#{print $1}就是将某一行（一条记录）中以空格为分割符的第一个字段打印出来\nusername=`echo $line | awk '{print $2}'`\n#passwd=`echo $line | awk '{print $3}'`\nsource=`echo $line | awk '{print $3}'`\ntarget=`echo $line | awk '{print $4}'`\n$dir/cpExeShell.sh $host $username $source $target\nif [ $? -eq 0 ]; then\n    echo \"succeed\"\nelse\n    echo \"failed\"\nfi\ndone < $dir/host.txt\n")])])]),t("h3",{attrs:{id:"补充"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[e._v("#")]),e._v(" 补充：")]),e._v(" "),t("h4",{attrs:{id:"shell脚本中判断上一个命令是否执行成功"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#shell脚本中判断上一个命令是否执行成功"}},[e._v("#")]),e._v(" shell脚本中判断上一个命令是否执行成功")]),e._v(" "),t("p",[e._v("shell中使用符号“$?”来显示上一条命令执行的返回值，如果为0则代表执行成功，其他表示失败。")]),e._v(" "),t("p",[e._v("结合if-else语句实现判断上一个命令是否执行成功。")]),e._v(" "),t("p",[e._v("经过验证，该方法也适用于make命令，并不仅仅限于shell 命令。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v('if [ $? -eq 0 ]; then\n    echo "succeed"\nelse\n    echo "failed"\nfi\n')])])]),t("p",[e._v("shell中的比较符号如下：")]),e._v(" "),t("p",[e._v("-eq    等于")]),e._v(" "),t("p",[e._v("-ne    不等于")]),e._v(" "),t("p",[e._v("-gt    大于")]),e._v(" "),t("p",[e._v("-lt    小于")]),e._v(" "),t("p",[e._v("ge    大于等于")]),e._v(" "),t("p",[e._v("le    小于等于")]),e._v(" "),t("h4",{attrs:{id:"linux-expect详解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux-expect详解"}},[e._v("#")]),e._v(" linux expect详解")]),e._v(" "),t("p",[e._v("expect是一个自动化交互套件，主要应用于执行命令和程序时，系统以交互形式要求输入指定字符串，实现交互通信。")]),e._v(" "),t("p",[e._v("expect自动交互流程：")]),e._v(" "),t("p",[e._v("spawn启动指定进程---expect获取指定关键字---send向指定程序发送指定字符---执行完成退出.")]),e._v(" "),t("p",[e._v("expect常用命令总结:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("spawn               交互程序开始后面跟命令或者指定程序\nexpect              获取匹配信息匹配成功则执行expect后面的程序动作\nsend exp_send       用于发送指定的字符串信息\nexp_continue        在expect中多次匹配就需要用到\nsend_user           用来打印输出 相当于shell中的echo\nexit                退出expect脚本\neof                 expect执行结束 退出\nset                 定义变量\nputs                输出变量\nset timeout         设置超时时间\ninteract 　　　　　　 允许用户交互")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);