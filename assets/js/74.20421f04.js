(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{319:function(t,a,e){t.exports=e.p+"assets/img/01.d92fa9f3.jpg"},750:function(t,a,e){"use strict";e.r(a);var _=e(14),s=Object(_.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"mysql事务与存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql事务与存储引擎"}},[t._v("#")]),t._v(" MySQL事务与存储引擎")]),t._v(" "),a("h2",{attrs:{id:"_3-1-数据库事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-数据库事务"}},[t._v("#")]),t._v(" 3.1-数据库事务")]),t._v(" "),a("h3",{attrs:{id:"什么是事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是事务"}},[t._v("#")]),t._v(" 什么是事务")]),t._v(" "),a("ul",[a("li",[t._v("一系列有序的数据库操作：\n"),a("ul",[a("li",[t._v("要么全部成功")]),t._v(" "),a("li",[t._v("要么全部回退到操作前的状态")]),t._v(" "),a("li",[t._v("中间状态对其他连接不可见")])])]),t._v(" "),a("li",[t._v("事务的基本操作：\n| 基本操作 | 说明 |\n| :------------- | :------------- |\n| start transaction | 开始事务 |\n| commit | 提交(全部完成) |\n| rollback | 回滚(回到初始状态) |")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 开启一个事务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 或者使用(非标准sql)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 事务结束，插入成功")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 事务结束，没有插入数据")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rollback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("savepoint")]),t._v(" a1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 回滚到指定的保存点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rollback")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" a1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"自动提交"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动提交"}},[t._v("#")]),t._v(" 自动提交")]),t._v(" "),a("ul",[a("li",[t._v("autocommit可以在session级别设置")]),t._v(" "),a("li",[t._v("每个DML操作都自动提交")]),t._v(" "),a("li",[t._v("DDL永远都是自动提交，无法通过rollback回滚")])]),t._v(" "),a("h3",{attrs:{id:"事务的四个基本属性-acid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的四个基本属性-acid"}},[t._v("#")]),t._v(" 事务的四个基本属性(ACID)")]),t._v(" "),a("ul",[a("li",[t._v("原子性(Atomicity)")]),t._v(" "),a("li",[t._v("一致性(Consistency)")]),t._v(" "),a("li",[t._v("隔离性(Isolation)")]),t._v(" "),a("li",[t._v("持久性(Durability)")])]),t._v(" "),a("h3",{attrs:{id:"事务的原子性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的原子性"}},[t._v("#")]),t._v(" 事务的原子性")]),t._v(" "),a("ul",[a("li",[t._v("包含在事务中的操作要么全部被执行，要么都不执行")]),t._v(" "),a("li",[t._v("中途数据库或应用发生异常，未提交的事务都应该被回滚")])]),t._v(" "),a("h3",{attrs:{id:"事务的一致性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的一致性"}},[t._v("#")]),t._v(" 事务的一致性")]),t._v(" "),a("ul",[a("li",[t._v("数据的正确性，合理性，完整性")]),t._v(" "),a("li",[t._v("数据一致性应该符合应用需要规则：\n"),a("ul",[a("li",[t._v("余额不能是负数")]),t._v(" "),a("li",[t._v("交易对象必须先有账号")]),t._v(" "),a("li",[t._v("用户账号不能重复")])])]),t._v(" "),a("li",[t._v("事务的结果需要满足数据的一致性约束")])]),t._v(" "),a("h3",{attrs:{id:"事物的持久性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事物的持久性"}},[t._v("#")]),t._v(" 事物的持久性")]),t._v(" "),a("ul",[a("li",[t._v("提交完成的事务对数据库的影响必须是永久性的\n"),a("ul",[a("li",[t._v("数据库异常不会丢失事务更新")]),t._v(" "),a("li",[t._v("通常认为成功写入磁盘的数据即为持久化成功")])])])]),t._v(" "),a("h3",{attrs:{id:"事务的持久化的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的持久化的实现"}},[t._v("#")]),t._v(" 事务的持久化的实现")]),t._v(" "),a("ul",[a("li",[t._v("数据文件持久化\n"),a("ul",[a("li",[t._v("随机同步刷新(慢)")])])]),t._v(" "),a("li",[t._v("事务日志持久化与实例恢复\n"),a("ul",[a("li",[t._v("顺序同步刷新(快) -> 事务日志")]),t._v(" "),a("li",[t._v("随机异步刷新 -> 磁盘")]),t._v(" "),a("li",[t._v("事务日志 -> 磁盘(实例恢复)")])])])]),t._v(" "),a("h3",{attrs:{id:"事务的隔离性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的隔离性"}},[t._v("#")]),t._v(" 事务的隔离性")]),t._v(" "),a("ul",[a("li",[t._v("数据库事务在提交完成前，中间的任何数据变化对其他的事务都是不可见的。")])]),t._v(" "),a("h3",{attrs:{id:"数据库隔离现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库隔离现象"}},[t._v("#")]),t._v(" 数据库隔离现象")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("隔离现象")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("脏读(Dirty Read)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务B读到事务A尚未提交的数据变更")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("不可重复读(NonRepeatable Read)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务B读取前后两次读取一条记录之间该记录被事务A修改并提交，于是事务B读到了不一样的结果")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("幻读(Phantom Read)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务B按条件匹配到了若干行记录并修改。但是由于修改过程中事务A新插入了符合条件记录，导致B更新完成后发现仍有符合条件却未被更新的记录。")])])])]),t._v(" "),a("h3",{attrs:{id:"数据库隔离等级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库隔离等级"}},[t._v("#")]),t._v(" 数据库隔离等级")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("隔离等级")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("脏读")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("不可重复读")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("幻读")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("未提交读")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("已提交读")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("可重复读")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可能")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("可串行化读")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不可能")])])])]),t._v(" "),a("h3",{attrs:{id:"mysql的事务隔离级别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql的事务隔离级别"}},[t._v("#")]),t._v(" MySQL的事务隔离级别")]),t._v(" "),a("ul",[a("li",[t._v("InnoDB默认标记为可重复读")]),t._v(" "),a("li",[t._v("InnoDB并不是标准定义上的课重复读")]),t._v(" "),a("li",[t._v("InnoDB默认在可重复读的基础上避免幻读")])]),t._v(" "),a("h3",{attrs:{id:"mysql事务隔离级别设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql事务隔离级别设置"}},[t._v("#")]),t._v(" MySQL事务隔离级别设置")]),t._v(" "),a("ul",[a("li",[t._v("可在global/session/下个事务，级别分别进行设置")]),t._v(" "),a("li",[t._v("建议使用Read committed(同Oracle)")]),t._v(" "),a("li",[t._v("或者建议使用默认的Repeatable read")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" tx_isolation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 设置隔离级别")]),t._v("\n")])])]),a("h3",{attrs:{id:"事务与并发写"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务与并发写"}},[t._v("#")]),t._v(" 事务与并发写")]),t._v(" "),a("ul",[a("li",[t._v("某个正在更新的记录再提交或回滚前不能被其他事务同时更新")])]),t._v(" "),a("h3",{attrs:{id:"事务回滚的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务回滚的实现"}},[t._v("#")]),t._v(" 事务回滚的实现")]),t._v(" "),a("ul",[a("li",[t._v("回滚段(rollback segment)与数据前像")])]),t._v(" "),a("h2",{attrs:{id:"_3-2-存储引擎概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-存储引擎概述"}},[t._v("#")]),t._v(" 3.2-存储引擎概述")]),t._v(" "),a("h3",{attrs:{id:"mysql程序层次架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql程序层次架构"}},[t._v("#")]),t._v(" MySQL程序层次架构")]),t._v(" "),a("p",[a("img",{attrs:{src:e(319),alt:"MySQL架构"}})]),t._v(" "),a("h3",{attrs:{id:"mysql存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql存储引擎"}},[t._v("#")]),t._v(" MySQL存储引擎")]),t._v(" "),a("ul",[a("li",[t._v("有多种可选方案，可插拔，可修改存储引擎")]),t._v(" "),a("li",[t._v("基于表选择使用何种存储引擎")])]),t._v(" "),a("h3",{attrs:{id:"主要存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主要存储引擎"}},[t._v("#")]),t._v(" 主要存储引擎")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("存储引擎")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("常用度")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("支持事务")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("InnoDB")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("主要，推荐")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("是")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("MyISAM")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("古老，偶尔有用，系统表")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("否")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("MEMORY")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("偶尔临时表有用，纯内存")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("否")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("BLACKHOLE")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("不用来存放数据，个别特殊用处")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("否")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("TokuDB")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("新颖，个别特殊场景有奇效")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("是")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("Cluster")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("新颖，分布式，内存，线上不要用")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("是")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb存储引擎"}},[t._v("#")]),t._v(" InnoDB存储引擎")]),t._v(" "),a("ul",[a("li",[t._v("索引组织表")]),t._v(" "),a("li",[t._v("支持事务")]),t._v(" "),a("li",[t._v("支持行级锁")]),t._v(" "),a("li",[t._v("数据块缓存")]),t._v(" "),a("li",[t._v("日志持久化")]),t._v(" "),a("li",[t._v("稳定可靠，性能好，线上尽量使用InnoDB")])]),t._v(" "),a("h3",{attrs:{id:"myisam存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#myisam存储引擎"}},[t._v("#")]),t._v(" MyISAM存储引擎")]),t._v(" "),a("ul",[a("li",[t._v("堆表")]),t._v(" "),a("li",[t._v("不支持事务")]),t._v(" "),a("li",[t._v("只维护索引缓存池，表数据缓存交给操作系统")]),t._v(" "),a("li",[t._v("锁粒度较大")]),t._v(" "),a("li",[t._v("数据文件可以直接拷贝，偶尔可能会用上")]),t._v(" "),a("li",[t._v("不建议线上业务数据使用")])]),t._v(" "),a("h3",{attrs:{id:"mwmory存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mwmory存储引擎"}},[t._v("#")]),t._v(" MWMORY存储引擎")]),t._v(" "),a("ul",[a("li",[t._v("数据全内存存放，无法持久化")]),t._v(" "),a("li",[t._v("性能较高")]),t._v(" "),a("li",[t._v("不支持事务")]),t._v(" "),a("li",[t._v("适合偶尔作为临时表使用")]),t._v(" "),a("li",[a("code",[t._v("create temporary table tmp (id int) engine = memory ;")])])]),t._v(" "),a("h3",{attrs:{id:"blackhole存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#blackhole存储引擎"}},[t._v("#")]),t._v(" BLACKHOLE存储引擎")]),t._v(" "),a("ul",[a("li",[t._v("数据不作任何存储")]),t._v(" "),a("li",[t._v("利用MySQL Replicate，充当日志服务器")]),t._v(" "),a("li",[t._v("在MySQL Replicate环境中充当代理主")])]),t._v(" "),a("h3",{attrs:{id:"tokudb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tokudb"}},[t._v("#")]),t._v(" TokuDB")]),t._v(" "),a("ul",[a("li",[t._v("分形树存储结构")]),t._v(" "),a("li",[t._v("支持事务")]),t._v(" "),a("li",[t._v("行锁")]),t._v(" "),a("li",[t._v("压缩效率较高")]),t._v(" "),a("li",[t._v("适合大批量insert的场景")])]),t._v(" "),a("h3",{attrs:{id:"mysql-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-cluster"}},[t._v("#")]),t._v(" MySQL Cluster")]),t._v(" "),a("ul",[a("li",[t._v("多主分布式集群")]),t._v(" "),a("li",[t._v("数据节点间冗余，高可用")]),t._v(" "),a("li",[t._v("支持事务")]),t._v(" "),a("li",[t._v("设计上易于扩展")]),t._v(" "),a("li",[t._v("面向未来，线上慎用")])]),t._v(" "),a("h3",{attrs:{id:"改变表的存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#改变表的存储引擎"}},[t._v("#")]),t._v(" 改变表的存储引擎")]),t._v(" "),a("p",[a("code",[t._v("alter table m ENGINE=innodb;")])]),t._v(" "),a("h2",{attrs:{id:"_3-3-innodb存储引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-innodb存储引擎"}},[t._v("#")]),t._v(" 3.3-InnoDB存储引擎")]),t._v(" "),a("h3",{attrs:{id:"innodb存储引擎体系架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb存储引擎体系架构"}},[t._v("#")]),t._v(" InnoDB存储引擎体系架构")]),t._v(" "),a("p",[a("img",{attrs:{src:"/sorence/images/02.png",alt:"InnoDB"}})]),t._v(" "),a("h3",{attrs:{id:"innodb相关的磁盘文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb相关的磁盘文件"}},[t._v("#")]),t._v(" InnoDB相关的磁盘文件")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("文件")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("名称")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("数量")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("位置")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("系统表空间")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("ibdata1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("一个实例一个")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_data_home_dir")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("日志文件")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("ib_logfile0/1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("一个实例两个(可配置)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_log_group_home_dir")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("表定义文件")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("表名.frm")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("每张表一个")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("Schema目录下")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("表数据文件")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("表名.ibd")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("如果innodb_file_per_table = 1, 则每张表一个")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("Schema目录下")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb系统表空间文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb系统表空间文件"}},[t._v("#")]),t._v(" InnoDB系统表空间文件")]),t._v(" "),a("ul",[a("li",[t._v("ibdata1里存放了什么:\n"),a("ul",[a("li",[t._v("回滚段")]),t._v(" "),a("li",[t._v("所有InnoDB表元数据信息")]),t._v(" "),a("li",[t._v("Double Write, Insert buffer dump等等....")])])]),t._v(" "),a("li",[t._v("自动扩展机制")])]),t._v(" "),a("h3",{attrs:{id:"innodb与磁盘文件有关的参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb与磁盘文件有关的参数"}},[t._v("#")]),t._v(" InnoDB与磁盘文件有关的参数")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("参数")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("样例值")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("备注")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_data_home_dir")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("/data/mysql/node_1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("数据主目录")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_log_group_home_dir")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("/data/mysql/node_1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("一般同上")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_data_file_path")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("ibdata1:512M:autoextned")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("请开启autoextned")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_autoextend_increment")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("128")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("MB,勿太大或太小")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_file_per_table")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("强烈建议开启")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_log_file_size")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("100MB")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("性能相关")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_log_files_in_group")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("性能相关")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb数据文件存储结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb数据文件存储结构"}},[t._v("#")]),t._v(" InnoDB数据文件存储结构")]),t._v(" "),a("ul",[a("li",[t._v("索引组织表(聚簇表)")]),t._v(" "),a("li",[t._v("根据表逻辑主键排序")]),t._v(" "),a("li",[t._v("数据节点每页16K")]),t._v(" "),a("li",[t._v("根据主键寻址速度很快")]),t._v(" "),a("li",[t._v("主键值递增的insert插入效率较好")]),t._v(" "),a("li",[t._v("主键值随机insert插入效率差")]),t._v(" "),a("li",[t._v("因此，InnoDB表必须指定主键，建议使用自增数字")])]),t._v(" "),a("h3",{attrs:{id:"innodb数据块缓存池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb数据块缓存池"}},[t._v("#")]),t._v(" InnoDB数据块缓存池")]),t._v(" "),a("ul",[a("li",[t._v("数据的读写需要经过缓存")]),t._v(" "),a("li",[t._v("数据以整页(16K)为单位读取到缓存中")]),t._v(" "),a("li",[t._v("缓存中的数据以LRU策略换出")]),t._v(" "),a("li",[t._v("IO效率高，性能好")])]),t._v(" "),a("h3",{attrs:{id:"innodb-buffer-pool相关参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb-buffer-pool相关参数"}},[t._v("#")]),t._v(" InnoDB Buffer Pool相关参数")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("参数")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("样例值")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("备注")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_buffer_pool_size")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("10G")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("根据总物理内存设置")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb数据持久化与事务日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb数据持久化与事务日志"}},[t._v("#")]),t._v(" InnoDB数据持久化与事务日志")]),t._v(" "),a("ul",[a("li",[t._v("事务日志实时持久化")]),t._v(" "),a("li",[t._v("内存变化数据(脏数据)增量异步刷出到磁盘")]),t._v(" "),a("li",[t._v("实例故障靠重放日志恢复")]),t._v(" "),a("li",[t._v("性能好，可靠，恢复快")])]),t._v(" "),a("h3",{attrs:{id:"innodb日志持久化相关参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb日志持久化相关参数"}},[t._v("#")]),t._v(" InnoDB日志持久化相关参数")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("参数")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("样例值")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("备注")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("innodb_flush_log_at_trx_commit")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可选：0：每隔1s写入并持久化一次日志。1：每次commit都写入并持久化日志。2：每次提交日志写到内存，每1s持久化一次")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb行级锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb行级锁"}},[t._v("#")]),t._v(" InnoDB行级锁")]),t._v(" "),a("ul",[a("li",[t._v("写不阻塞读")]),t._v(" "),a("li",[t._v("不同行间的写互相不阻塞")]),t._v(" "),a("li",[t._v("并发性能好")])]),t._v(" "),a("h3",{attrs:{id:"innodb与事务acid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb与事务acid"}},[t._v("#")]),t._v(" InnoDB与事务ACID")]),t._v(" "),a("ul",[a("li",[t._v("事务ACID特性完整支持\n"),a("ul",[a("li",[t._v("回滚段失败回滚")]),t._v(" "),a("li",[t._v("支持主外键约束")]),t._v(" "),a("li",[t._v("事务版本+回滚段=MVCC")]),t._v(" "),a("li",[t._v("事务日志持久化")])])]),t._v(" "),a("li",[t._v("默认可重复读隔离级别，可以调整")])]),t._v(" "),a("h2",{attrs:{id:"_3-4-innodb事务锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-innodb事务锁"}},[t._v("#")]),t._v(" 3.4-InnoDB事务锁")]),t._v(" "),a("h3",{attrs:{id:"什么是计算机程序锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是计算机程序锁"}},[t._v("#")]),t._v(" 什么是计算机程序锁")]),t._v(" "),a("ul",[a("li",[t._v("计算机程序锁\n"),a("ul",[a("li",[t._v("控制对共享资源进行并发访问")]),t._v(" "),a("li",[t._v("保护数据的完整性和一致性")])])])]),t._v(" "),a("h3",{attrs:{id:"数据库中的锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库中的锁"}},[t._v("#")]),t._v(" 数据库中的锁")]),t._v(" "),a("ul",[a("li",[t._v("分为两个大类")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}}),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("lock")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("latch/mutex")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("对象")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("线程")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("保护")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("数据库逻辑内容")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("内存数据结构")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("持续时间")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务过程中")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("临界资源争抢")])])])]),t._v(" "),a("ul",[a("li",[t._v("我们主要关心的是事务锁")])]),t._v(" "),a("h3",{attrs:{id:"数据库事务并发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库事务并发"}},[t._v("#")]),t._v(" 数据库事务并发")]),t._v(" "),a("ul",[a("li",[t._v("对同一行记录的修改必须串行化")])]),t._v(" "),a("h3",{attrs:{id:"事务锁粒度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务锁粒度"}},[t._v("#")]),t._v(" 事务锁粒度")]),t._v(" "),a("ul",[a("li",[t._v("行锁\n"),a("ul",[a("li",[t._v("InnoDB, Oracle")])])]),t._v(" "),a("li",[t._v("页锁\n"),a("ul",[a("li",[t._v("SQL Server")])])]),t._v(" "),a("li",[t._v("表锁\n"),a("ul",[a("li",[t._v("MyISAM, Memory")])])]),t._v(" "),a("li",[t._v("锁升级")])]),t._v(" "),a("h3",{attrs:{id:"innodb存储引擎中的锁模式与粒度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb存储引擎中的锁模式与粒度"}},[t._v("#")]),t._v(" InnoDB存储引擎中的锁模式与粒度")]),t._v(" "),a("ul",[a("li",[t._v("四种基本锁模式\n"),a("ul",[a("li",[t._v("共享锁(S) - 读锁 - 行锁")]),t._v(" "),a("li",[t._v("排他锁(X) - 写锁 - 行锁")]),t._v(" "),a("li",[t._v("意向共享锁(IS) - 表级")]),t._v(" "),a("li",[t._v("意向排他锁(IX) - 表级")])])]),t._v(" "),a("li",[t._v("意向锁\n"),a("ul",[a("li",[t._v("意向锁总是自动先加，并且意向锁自动加自动释放")]),t._v(" "),a("li",[t._v("意向锁提示数据库这个session将要在接下来施加何种锁")]),t._v(" "),a("li",[t._v("意向锁和X/S锁级别不同，除了阻塞全表级别的X/S锁外其他任何锁")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb锁模式互斥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb锁模式互斥"}},[t._v("#")]),t._v(" InnoDB锁模式互斥")]),t._v(" "),a("p",[a("img",{attrs:{src:"/sorence/images/03.png",alt:"锁互斥"}})]),t._v(" "),a("h3",{attrs:{id:"数据库加锁操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库加锁操作"}},[t._v("#")]),t._v(" 数据库加锁操作")]),t._v(" "),a("ul",[a("li",[t._v("一般的select语句不加任何锁，也不会被任何事物锁阻塞\n"),a("ul",[a("li",[t._v("读的隔离性由MVCC确保")])])]),t._v(" "),a("li",[t._v("S锁\n"),a("ul",[a("li",[t._v("手动："),a("code",[t._v("select * from tb_test lock in share mode;")])]),t._v(" "),a("li",[t._v("自动：insert前")])])]),t._v(" "),a("li",[t._v("X锁\n"),a("ul",[a("li",[t._v("手动："),a("code",[t._v("select * from tb_test lock for update;")])]),t._v(" "),a("li",[t._v("自动：update，delete前")])])])]),t._v(" "),a("h3",{attrs:{id:"innodb行锁的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb行锁的实现"}},[t._v("#")]),t._v(" InnoDB行锁的实现")]),t._v(" "),a("ul",[a("li",[t._v("通过索引项加锁实现\n"),a("ul",[a("li",[t._v("只有条件走索引才能实现行级锁")]),t._v(" "),a("li",[t._v("索引上有重复值，可能锁住多个记录")]),t._v(" "),a("li",[t._v("查询有多个索引可以走，可以对不同索引加锁")]),t._v(" "),a("li",[t._v("是否对索引加锁实际上取决于MySQL执行计划")])])]),t._v(" "),a("li",[t._v("自增主键做条件更新，性能最好")])]),t._v(" "),a("p",[t._v("没有索引的话会对整张表加锁。")]),t._v(" "),a("h3",{attrs:{id:"innodb的gap-lock"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb的gap-lock"}},[t._v("#")]),t._v(" InnoDB的gap lock")]),t._v(" "),a("ul",[a("li",[t._v("什么是幻读")]),t._v(" "),a("li",[t._v("gap lock消灭幻读\n"),a("ul",[a("li",[t._v("InnoDB消灭幻读仅仅为了确保statement模式replicate的主从一致性")])])]),t._v(" "),a("li",[t._v("小心gap lock")]),t._v(" "),a("li",[t._v("自增主键做条件更新，性能最好")])]),t._v(" "),a("h3",{attrs:{id:"死锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#死锁"}},[t._v("#")]),t._v(" 死锁")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("什么是死锁")]),t._v(" "),a("ul",[a("li",[t._v("A、B两个事务，A先更新t1，同时B更新t2，A再更新t2，B再更新t1就发生了死锁。")])])]),t._v(" "),a("li",[a("p",[t._v("死锁数据库自动解决")]),t._v(" "),a("ul",[a("li",[t._v("数据库挑选冲突事务中回滚代价较小的事务回滚")])])]),t._v(" "),a("li",[a("p",[t._v("死锁预防")]),t._v(" "),a("ul",[a("li",[t._v("单表死锁可以根据批量更新里的更新条件排序")]),t._v(" "),a("li",[t._v("可能冲突的跨表事务尽量避免并发")]),t._v(" "),a("li",[t._v("尽量缩短事务长度")])])])]),t._v(" "),a("h3",{attrs:{id:"业务逻辑加锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#业务逻辑加锁"}},[t._v("#")]),t._v(" 业务逻辑加锁")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("业务流程中的悲观锁")]),t._v(" "),a("ul",[a("li",[t._v("任何的并发修改都有可能造成我们的业务逻辑最终的错误，在事务流程中一开始就加锁，最后释放")])])]),t._v(" "),a("li",[a("p",[t._v("如何缩短锁的时间")])])])])}),[],!1,null,null,null);a.default=s.exports}}]);